PyEMV
-----

|pypi| |coverage|

This package provides methods for the generation of the
Application Cryptograms (TC, ARQC, or AAC) generated by the ICC and the
Authorisation Response Cryptogram (ARPC) generated by the issuer and
verified by the ICC. In addition, this package supports secure messaging
integrity and confidentiality.

Install::

    pip install pyemv

PyEMV consists of the following modules:

    - `pyemv.ac` - Application Cryptogram support for ARQC, AAC, TC, and
      ARPC
    - `pyemv.sm` - Secure Messaging support for script command integrity
      and confidentiality. It also provides support for PIN blocks. 
    - `pyemv.kd` - Key Derivation support for ICC master keys and session keys

Key Derivation
~~~~~~~~~~~~~~

ICC Master Key derivation method A and B:

.. code-block:: python

    >>> from pyemv import kd
    >>> iss_mk = bytes.fromhex('0123456789ABCDEFFEDCBA9876543210')
    >>> pan = b'99012345678901234'
    >>> psn = b'45'
    >>> icc_mk_a = kd.derive_icc_mk_a(iss_mk, pan, psn)
    >>> icc_mk_a.hex().upper()
    '67F8292358083E5EA7AB7FDA58D53B6B'
    >>> icc_mk_b = kd.derive_icc_mk_b(iss_mk, pan, psn)
    >>> icc_mk_b.hex().upper()
    '985EC4FD3EDF6162E31AF1C7D0543416'

Common Session Key derivation:

.. code-block:: python

    >>> r = bytes.fromhex('1234567890123456')
    >>> sk = kd.derive_common_sk(icc_mk_a, r)
    >>> sk.hex().upper()
    '29B33180E567CE38EA4CBC9D753B0E61'

Cryptogram Generation
~~~~~~~~~~~~~~~~~~~~~

Application Request Cryptogram generation:

.. code-block:: python

    >>> from pyemv import ac
    >>> ac_data = bytes.fromhex('0123456789ABCDEF0123456789ABCDEF')
    >>> arqc = ac.generate_ac(sk, ac_data)
    >>> arqc.hex().upper()
    'FA624250B008B59A'

Application Response Cryptogram generation method 1 and 2:

.. code-block:: python

    >>> arpc_rc = bytes.fromhex('0000')
    >>> arpc = ac.generate_arpc_1(sk, arqc, arpc_rc)
    >>> arpc.hex().upper()
    '45D4255EEF10C920'
    >>> csu = bytes.fromhex('00000000')
    >>> arpc = ac.generate_arpc_2(sk, arqc, csu)
    >>> arpc.hex().upper()
    'CB56FA40'

Secure Messaging
~~~~~~~~~~~~~~~~

Secure Messaging Integrity (MAC):

.. code-block:: python

    >>> from pyemv import sm
    >>> sk_smi = bytes.fromhex('0123456789ABCDEFFEDCBA9876543210')
    >>> command = bytes.fromhex('8424000008')
    >>> mac = sm.generate_command_mac(sk_smi, command)
    >>> mac.hex().upper()
    '0BFFF5DF3FAA24E1'

Secure Messaging Confidentiality:

.. code-block:: python

    >>> pin_block = sm.format_iso9564_2_pin_block(b'9999')
    >>> pin_block.hex().upper()
    '249999FFFFFFFFFF'
    >>> sk_smc = bytes.fromhex('0123456789ABCDEFFEDCBA9876543210')
    >>> enc_data = sm.encrypt_command_data(sk_smc, pin_block,
    ...                                    sm.EncryptionType.EMV)
    >>> enc_data.hex().upper()
    '5A862D1381CCB94822CFDD706A376178'

Contribute
----------

`PyEMV` is hosted on `GitHub <https://github.com/manoutoftime/pyemv>`_.

Feel free to fork and send contributions over.

.. |pypi| image:: https://img.shields.io/pypi/v/pyemv.svg
    :alt: PyPI
    :target:  https://pypi.org/project/pyemv/

.. |coverage| image:: https://codecov.io/gh/manoutoftime/pyemv/branch/master/graph/badge.svg
    :alt: Test coverage
    :target: https://codecov.io/gh/manoutoftime/pyemv
