{% extends base.html %}

{% block title %}
<title>File Server</title>
{% end %}

{% block content %}
<div id="upload-box" class="layui-upload-drag" id="upimg">
  <i class="layui-icon">&#xe67c;</i>
  <input type="file" name="myfile" value="上传" multiple webkitdirectory="">
  <p>点击上传文件夹，或将文件拖拽到此处(截图可直接Ctrl+V粘贴上传)</p>
</div>
<div class="layui-progress hidden" lay-filter="upload" lay-showPercent="true">
  <div class="layui-progress-bar" lay-percent="0%"></div>
</div>

{% import os, urllib.parse %}
<div class="crumbs layui-col-md12">
  <a class="tree-toggle" href="javascript:;"><i class="layui-icon {{ 'layui-icon-shrink-right' if handler.get_cookie('tree') else 'layui-icon-spread-left' }}" style="font-size:18px"></i></a>
  <a class="btn-delete" href="javascript:;"><i class="layui-icon layui-icon-delete" style="font-size:20px"></i></a>
  <a class="btn-preview" href="javascript:;"><i class="layui-icon {{ 'layui-icon-pause' if handler.get_cookie('preview') else 'layui-icon-play' }}"></i></a>
  <a class="btn-display" href="javascript:;"><i class="layui-icon {{ 'layui-icon-list' if handler.get_cookie('display') else 'layui-icon-table' }}" style="font-size:20px"></i></a>
  {% set paths = handler.request.path.rstrip('/').split('/') %}
  <span class="layui-breadcrumb">
    {% for i, path in enumerate(paths) %}
    {% if i == 0 %}
    <a href="/"><i class="layui-icon layui-icon-home"></i></a>
    {% else %}
    <a href="{{ '/'.join(paths[:(i+1)]) }}">{{ urllib.parse.unquote(path) }}</a>
    {% end %}
    {% end %}
  </span>

</div>

<div class="layui-row">
  <div class="layui-col-md2" style="min-height:0.1px;">
    <ul id="tree" {% if not handler.get_cookie('tree') %}class="hidden"{% end %}></ul>
  </div>
  <div class="tree-table layui-col-md{{ 10 if handler.get_cookie('tree') else 12 }}">
    {% if handler.get_cookie('display') %}
    <div id="masonry" class="layui-row layui-col-space15" style="margin-top: 10px;">
      {% for entry in entries %}
      <div class="layui-col-md2">
        <div class="layui-card">
          <div class="layui-card-body">
            {% set icon = 'folder.png' if entry[3] else handler.icon.get(entry[0].suffix.lower(), 'file.png') %}
            <a href="/{{ entry[0] }}">
              {% if handler.get_cookie('preview') and entry[0].suffix.lower() in ['.jpg', '.jpeg', '.png', '.bmp', '.gif', '.webp'] %}
              <img style="display:block" src="/{{ entry[0] }}" {% if handler.w %}width="{{ int(handler.w) }}"{% end %} {% if handler.h %}height="{{ int(handler.h) }}"{% end %}>
              {% elif handler.get_cookie('preview') and entry[0].suffix.lower() in [] %}
              <video style="display:block" controls="controls">
                <source src="/{{ entry[0] }}" {% if handler.w %}width="{{ int(handler.w) }}"{% end %} {% if handler.h %}height="{{ int(handler.h) }}"{% end %}>
              </video>
              {% elif handler.get_cookie('preview') and entry[0].suffix.lower() in ['.mp3', '.amr', '.ogg', '.wav'] %}
              <audio style="display:block" controls="controls" ><source src="/{{ entry[0] }}"></audio>
              {% else %}
              {% set icon = 'folder.png' if entry[3] else handler.icon.get(entry[0].suffix.lower(), 'file.png') %}
              <img width=80 height=80 style="margin-bottom:3px" src="{{ static_url(f'img/{icon}') }}">
              {% end %}
              <p class="display-name">{{ entry[0].name }}</p>
            </a>
          </div>
        </div>
      </div>
      {% end %}
    </div>
    {% else %}
    <table class="layui-table table-hover table-bordered table-sm" lay-skin="line" align="center">
      <tbody>
        {% for entry in entries %}
        <tr>
          <td style="width:20px" class="select"><input type="checkbox"></td>
          <td style="text-align:left !important">
            {% if handler.get_cookie('preview') and entry[0].suffix.lower() in ['.jpg', '.jpeg', '.png', '.bmp', '.gif', '.webp'] %}
            <img style="display:block" src="/{{ entry[0] }}" {% if handler.w %}width="{{ int(handler.w) }}"{% end %} {% if handler.h %}height="{{ int(handler.h) }}"{% end %}>
            {% elif handler.get_cookie('preview') and entry[0].suffix.lower() in [] %}
            <video style="display:block" controls="controls">
              <source src="/{{ entry[0] }}" {% if handler.w %}width="{{ int(handler.w) }}"{% end %} {% if handler.h %}height="{{ int(handler.h) }}"{% end %}>
            </video>
            {% elif handler.get_cookie('preview') and entry[0].suffix.lower() in ['.mp3', '.amr', '.ogg', '.wav'] %}
            <audio style="display:block" controls="controls" ><source src="/{{ entry[0] }}"></audio>
            {% else %}
            {% set icon = 'folder.png' if entry[3] else handler.icon.get(entry[0].suffix.lower(), 'file.png') %}
            <img class="icon" src="{{ static_url(f'img/{icon}') }}">
            {% end %}
            <a class="display-name" href="/{{ entry[0] }}">{{ entry[0].name }}</a>
          </td>
          <td style="width:200px">
            {% if entry[0].suffix.lower() in ['.tar', '.gz', '.bz2', '.xz', '.tgz', '.bz2', '.bz', '.zip'] %}
            <button class="layui-btn layui-btn-secondary layui-btn-xs btn-compress">解压</button>
            {% elif entry[0].suffix.lower() in ['.json', '.yml', '.yaml', '.jpg', '.jpeg', '.ico', '.bmp', '.png', '.mp3', '.mp4', '.ogg', '.pdf', '.txt', '.md', '.py', '.sh', '.h', '.c', '.cpp', '.js', '.css', '.html', '.java', '.go', '.ini', '.vue', '.ipynb'] %}
            <button class="layui-btn layui-btn-success layui-btn-xs btn-open">预览</button>
            {% elif entry[3] %}
            <button class="layui-btn layui-btn-primary layui-btn-xs btn-compress">压缩</button>
            {% else %}
            <a href="/{{ entry[0] }}?f=download" class="layui-btn layui-btn-secondary layui-btn-xs">下载</a>
            {% end %}
            <a {% if not entry[3] %}href="/{{ entry[0] }}?f=download"{% end %} class="layui-btn layui-btn-secondary layui-btn-xs {% if entry[3] %}layui-btn-disabled{% end %}">
              <i class="layui-icon layui-icon-download-circle"></i>
            </a>
            <button class="layui-btn layui-btn-danger layui-btn-xs btn-delete btn-delete-single">
              <i class="layui-icon layui-icon-delete"></i>
            </button>
            <button data-clipboard-text="http://{{ handler.request.host }}/{{ entry[0] }}" class="layui-btn layui-btn-xs btn-copy">
              <i class="layui-icon layui-icon-link"></i>
            </button>
          </td>
          <td style="width:160px">{{ entry[1] }}</td>
          <td style="width:80px">{{ entry[2] }}</td>
        </tr>
        {% end %}
      </tbody>
    </table>
    {% end %}
    <div id="pagination"></div>
  </div>
</div>

{% end %}

{% block js %}
<script src="{{ static_url('js/imagesloaded.pkgd.min.js') }}"></script>
<script src="{{ static_url('js/masonry.pkgd.min.js') }}"></script>

<script>
  layui.use(['layer', 'element', 'tree'], function(){
    var layer = layui.layer;
    var element = layui.element;

    $(function(){
      var masonryNode = $('#masonry');
      if(masonryNode.length >= 1){
        masonryNode.imagesLoaded(function(){
          masonryNode.masonry({
            itemSelector: '.layui-col-md2',
            columnWidth: '.layui-col-md2',
            isAnimated: true,
          });
        });
      }

      var info = $("#upload-box p")
      $(document).on({
        dragenter: function(e){
          e.stopPropagation();
          e.preventDefault();
        },
        dragover: function(e){
          e.stopPropagation();
          e.preventDefault();
          info.html("松开鼠标开始上传")
        },
        dragleave: function(e){
          e.stopPropagation();
          e.preventDefault();
          info.html("拖拽到这里上传");
        },
        drop: function(e){
          e.stopPropagation();
          e.preventDefault();
          upload(e.originalEvent.dataTransfer.files);
        },
        paste_unused: function(e){
          e.stopPropagation();
          e.preventDefault();
          var clipboardData = (e.clipboardData || e.originalEvent.clipboardData)
          if(clipboardData.items){
            var items = clipboardData.items
            for(i=0; i < items.length; i++){
              if (items[i].type.indexOf("image") >= 0) {
                upload([items[i].getAsFile()])
              }
            }
          }
        }
      });

      function upload(files){
        info.html("上传中...");
        $(".layui-progress").removeClass("hidden")
        var xhr = new XMLHttpRequest();
        var formData = new FormData();
        for(var i = 0; i < files.length; i++){
          formData.append("myfile", files[i]);
        }
        xhr.upload.onprogress = function(e){
          if(e.lengthComputable){
            var percent = Math.round((e.loaded * 100)/ e.total);
            info.html("上传中(" + percent + "%)...");
            element.progress("upload", percent + "%");
          }
        }
        xhr.onload = function(e){
          info.html("上传成功，刷新页面");
          location.reload();
        }
        xhr.onerror = function(e){
          info.html("上传失败")
        }
        xhr.open("post", location.pathname, true);
        xhr.send(formData);
      }

      $("input[type=file]").on("change", function(){
        upload(this.files);
      });

      $(document).on("click", ".select", function(){
        var checkbox = $(this).parents("tr").find("input[type=checkbox]")
        checkbox.prop('checked', !checkbox.prop('checked'))
      });

      $(document).on("click", "input[type=checkbox]", function(event){
        event.stopPropagation()
      });

      $(document).on("click", ".btn-delete", function(){
        if($(this).hasClass("btn-delete-single")){
          $(this).parents("tr").find("input[type=checkbox]").prop('checked', true);
        }
        layer.confirm('确定删除？', {icon: 2, title: '提示'}, function(index){
          layer.msg('deleting', {time: 6000000});
          $("input:checkbox:checked").each(function(){
            var tr = $(this).parents("tr");
            var url = tr.find("a").attr("href");
            $.ajax({
              url: url,
              method: "DELETE",
              success: function(data, textStatus, jqXHR){
                tr.slideUp();
              },
              error: function(jqXHR, textStatus, errorThrown){
                alert(textStatus);
              },
              complete: function(jqXHR){
                layer.closeAll()
              }
            })
          })
        })
      });

      $(document).on("click", ".btn-compress", function(){
        var tr = $(this).parents("tr");
        var url = tr.find("a").attr("href");
        layer.msg('executing', {time: 6000000});
        $.post(url, {action: 'execute'}, function(ret){
          layer.msg('succeed');
          location.reload();
        })
      });

      $(document).on("click", ".btn-preview", function(){
          if(getCookie("preview")){
            removeCookie("preview")
          }else{
            setCookie("preview", "on")
          }
          layer.msg("切换中...")
          location.reload()
      })

      $(document).on("click", ".btn-display", function(){
          if(getCookie("display")){
            removeCookie("display")
          }else{
            setCookie("display", "on")
          }
          layer.msg("切换中...")
          location.reload()
      })

      $(document).on("click", ".btn-open", function(){
        var tr = $(this).parents("tr");
        var url = tr.find("a").attr("href") + '?f=preview';
        var title = tr.find("a").text();
        layer.open({
          type: 2,
          title: title,
          content: url,
          shadeClose: true,
          area: ['1000px', '700px'],
          success: function(layero, index){
            $("iframe").contents().find("img").css({"max-width":"100%", "margin": "0 auto"});
          }
        });
      })

      if(getCookie('tree')){
        layui.tree({
          elem: '#tree',
          nodes: JSON.parse('{% raw nodes %}'),
        });
      }

    $(document).on("click", ".tree-toggle", function(){
      if(getCookie("tree")){
        removeCookie("tree")
        $('.tree-toggle i').removeClass("layui-icon-shrink-right").addClass("layui-icon-spread-left")
        $("#tree").addClass("hidden")
        $(".tree-table").addClass("layui-col-md12").removeClass("layui-col-md9")
      }else{
        setCookie("tree", "on")
        $('.tree-toggle i').removeClass("layui-icon-spread-left").addClass("layui-icon-shrink-right")
        $("#tree").removeClass("hidden")
        $(".tree-table").addClass("layui-col-md9").removeClass("layui-col-md12")
        location.reload()
      }
    })
    })
  });

</script>
{% end %}
