{"version":3,"file":"patterns.js","sources":["../../node_modules/@wq/app/src/patterns.js"],"sourcesContent":["import tmpl from '@wq/template';\n\nvar patterns = {\n    name: 'patterns'\n};\n\nvar _templates, _pageContext, $;\n\npatterns.init = function(conf) {\n    _templates = (conf && conf.templates) || this.app.config.template.templates;\n    $ = (conf && conf.jQuery) || window.jQuery;\n};\n\npatterns.context = function(context, routeInfo) {\n    _pageContext = context;\n    if (routeInfo.mode === 'edit' && routeInfo.variant === 'new') {\n        return { new_attachment: true };\n    }\n};\n\npatterns.run = function($page, routeInfo) {\n    $page.find('button[data-wq-action=addattachment]').click(add);\n    $page.on('click', 'button[data-wq-action=removeattachment]', remove);\n    function add(evt) {\n        var $button = $(evt.target),\n            section = $button.data('wq-section'),\n            count = $page.find('.section-' + section).length;\n        patterns.addAttachment(\n            routeInfo.page,\n            section,\n            count,\n            $button,\n            routeInfo.mode\n        );\n    }\n    function remove(evt) {\n        var $button = $(evt.target),\n            section = $button.data('wq-section'),\n            $row = $button.parents('.section-' + section);\n        $row.remove();\n    }\n};\n\nfunction addAttachment(page, section, index, $button, mode) {\n    var template = _templates[page + '_' + (mode ? mode : 'edit')],\n        pattern = '{{#' + section + '}}([\\\\s\\\\S]+){{/' + section + '}}',\n        match,\n        $attachment,\n        context;\n    if (!template) {\n        return;\n    }\n    match = template.match(pattern);\n    if (!match) {\n        return;\n    }\n\n    context = {\n        '@index': index,\n        new_attachment: true\n    };\n    for (var key in _pageContext) {\n        context[key.replace(section + '.', '')] = _pageContext[key];\n    }\n    $attachment = $(tmpl.render(match[1], context));\n    if ($attachment.is('tr')) {\n        $button.parents('tr').before($attachment);\n        $attachment.enhanceWithin();\n    } else {\n        $button.parents('li').before($attachment);\n        $attachment.enhanceWithin();\n        $button.parents('ul').listview('refresh');\n    }\n}\n\nif (window.MSApp && window.MSApp.execUnsafeLocalFunction) {\n    patterns.addAttachment = function(page, section, index, $button, mode) {\n        window.MSApp.execUnsafeLocalFunction(function() {\n            addAttachment(page, section, index, $button, mode);\n        });\n    };\n} else {\n    patterns.addAttachment = addAttachment;\n}\n\nexport default patterns;\n"],"names":["patterns","name","_templates","_pageContext","$","init","conf","templates","app","config","template","jQuery","window","context","routeInfo","mode","variant","new_attachment","run","$page","find","click","add","on","remove","evt","$button","target","section","data","count","length","addAttachment","page","$row","parents","index","pattern","match","$attachment","key","replace","tmpl","render","is","before","enhanceWithin","listview","MSApp","execUnsafeLocalFunction"],"mappings":"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"}