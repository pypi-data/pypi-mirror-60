{"version":3,"file":"photos.js","sources":["../../node_modules/@wq/app/src/photos.js"],"sourcesContent":["/* global Camera */\nimport localForage from 'localforage';\n\nvar LOCALFORAGE_PREFIX = '__lfsc__:blob~~local_forage_type~image/jpeg~';\n\nvar photos = {\n    name: 'photos'\n};\n\nvar _defaults = {\n    quality: 75,\n    destinationType: 0 //Camera.DestinationType.DATA_URL\n};\n\nvar $, jqm, spin;\n\nphotos.init = function(config) {\n    $ = (config && config.jQuery) || window.jQuery;\n    spin = photos.app.spin;\n};\n\nphotos.context = function() {\n    return {\n        image_url: function() {\n            try {\n                return this.body && _getUrl(this.body);\n            } catch (e) {\n                // Image will be blank, but at least template won't crash\n            }\n        }\n    };\n};\n\nphotos.run = function($page) {\n    $page.on('change', 'input[type=file]', photos.preview);\n    $page.on('click', 'button[data-wq-action=take]', photos.take);\n    $page.on('click', 'button[data-wq-action=pick]', photos.pick);\n};\n\nphotos.preview = function(imgid, file) {\n    if (typeof imgid !== 'string' && !file) {\n        imgid = $(this).data('wq-preview');\n        if (!imgid) {\n            return;\n        }\n        file = this.files[0];\n        if (!file) {\n            return;\n        }\n    }\n    $('#' + imgid).attr('src', _getUrl(file));\n};\n\nfunction _getUrl(file) {\n    var URL = window.URL || window.webkitURL;\n    return URL && URL.createObjectURL(file);\n}\n\nphotos.take = function(input, preview) {\n    var options = $.extend(\n        {\n            sourceType: Camera.PictureSourceType.CAMERA,\n            correctOrientation: true,\n            saveToPhotoAlbum: true\n        },\n        _defaults\n    );\n    _start.call(this, options, input, preview);\n};\n\nphotos.pick = function(input, preview) {\n    var options = $.extend(\n        {\n            sourceType: Camera.PictureSourceType.SAVEDPHOTOALBUM\n        },\n        _defaults\n    );\n    _start.call(this, options, input, preview);\n};\n\nfunction _start(options, input, preview) {\n    if (typeof input !== 'string' && !preview) {\n        input = $(this).data('wq-input');\n        if (!input) {\n            return;\n        }\n        preview = jqm.activePage.find('#' + input).data('wq-preview');\n    }\n    navigator.camera.getPicture(\n        function(data) {\n            load(data, input, preview);\n        },\n        function(msg) {\n            error(msg);\n        },\n        options\n    );\n}\n\nphotos.base64toBlob = async function(data) {\n    await photos.app.store.ready;\n    var serializer = await localForage.getSerializer();\n    return serializer.deserialize(LOCALFORAGE_PREFIX + data);\n};\n\nphotos._files = {};\n\nphotos.storeFile = function(name, type, blob, input) {\n    // Save blob data for later retrieval\n    var file = {\n        name: name,\n        type: type,\n        body: blob\n    };\n    photos._files[name] = file;\n    if (input) {\n        $('#' + input).val(name);\n    }\n};\n\nfunction load(data, input, preview) {\n    spin.start('Loading image...');\n    photos.base64toBlob(data).then(function(blob) {\n        var number = Math.round(Math.random() * 1e10);\n        var name = $('#' + input).val() || 'photo' + number + '.jpg';\n        photos.storeFile(name, 'image/jpeg', blob, input);\n        spin.stop();\n        if (preview) {\n            photos.preview(preview, blob);\n        }\n    });\n}\n\nfunction error(msg) {\n    spin.start('Error Loading Image: ' + msg, 1.5, {\n        theme: jqm.pageLoadErrorMessageTheme,\n        textonly: true\n    });\n}\n\nexport default photos;\n"],"names":["LOCALFORAGE_PREFIX","photos","name","_defaults","quality","destinationType","$","jqm","spin","init","config","jQuery","window","app","context","image_url","body","_getUrl","e","run","$page","on","preview","take","pick","imgid","file","data","files","attr","URL","webkitURL","createObjectURL","input","options","extend","sourceType","Camera","PictureSourceType","CAMERA","correctOrientation","saveToPhotoAlbum","_start","call","SAVEDPHOTOALBUM","activePage","find","navigator","camera","getPicture","load","msg","error","base64toBlob","store","ready","localForage","getSerializer","serializer","deserialize","_files","storeFile","type","blob","val","start","then","number","Math","round","random","stop","theme","pageLoadErrorMessageTheme","textonly"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAGA,IAAIA,kBAAkB,GAAG,8CAAzB;AAEA,IAAIC,MAAM,GAAG;IACTC,IAAI,EAAE;CADV;AAIA,IAAIC,SAAS,GAAG;IACZC,OAAO,EAAE,EADG;IAEZC,eAAe,EAAE,CAFL;;CAAhB;AAKA,IAAIC,CAAJ,EAAOC,GAAP,EAAYC,IAAZ;;AAEAP,MAAM,CAACQ,IAAP,GAAc,UAASC,MAAT,EAAiB;IAC3BJ,CAAC,GAAII,MAAM,IAAIA,MAAM,CAACC,MAAlB,IAA6BC,MAAM,CAACD,MAAxC;IACAH,IAAI,GAAGP,MAAM,CAACY,GAAP,CAAWL,IAAlB;CAFJ;;AAKAP,MAAM,CAACa,OAAP,GAAiB,YAAW;WACjB;QACHC,SAAS,EAAE,qBAAW;gBACd;uBACO,KAAKC,IAAL,IAAaC,OAAO,CAAC,KAAKD,IAAN,CAA3B;aADJ,CAEE,OAAOE,CAAP,EAAU;;;KAJpB;CADJ;;AAYAjB,MAAM,CAACkB,GAAP,GAAa,UAASC,KAAT,EAAgB;IACzBA,KAAK,CAACC,EAAN,CAAS,QAAT,EAAmB,kBAAnB,EAAuCpB,MAAM,CAACqB,OAA9C;IACAF,KAAK,CAACC,EAAN,CAAS,OAAT,EAAkB,6BAAlB,EAAiDpB,MAAM,CAACsB,IAAxD;IACAH,KAAK,CAACC,EAAN,CAAS,OAAT,EAAkB,6BAAlB,EAAiDpB,MAAM,CAACuB,IAAxD;CAHJ;;AAMAvB,MAAM,CAACqB,OAAP,GAAiB,UAASG,KAAT,EAAgBC,IAAhB,EAAsB;QAC/B,OAAOD,KAAP,KAAiB,QAAjB,IAA6B,CAACC,IAAlC,EAAwC;QACpCD,KAAK,GAAGnB,CAAC,CAAC,IAAD,CAAD,CAAQqB,IAAR,CAAa,YAAb,CAAR;;YACI,CAACF,KAAL,EAAY;;;;QAGZC,IAAI,GAAG,KAAKE,KAAL,CAAW,CAAX,CAAP;;YACI,CAACF,IAAL,EAAW;;;;;IAIfpB,CAAC,CAAC,MAAMmB,KAAP,CAAD,CAAeI,IAAf,CAAoB,KAApB,EAA2BZ,OAAO,CAACS,IAAD,CAAlC;CAXJ;;AAcA,SAAST,OAAT,CAAiBS,IAAjB,EAAuB;QACfI,GAAG,GAAGlB,MAAM,CAACkB,GAAP,IAAclB,MAAM,CAACmB,SAA/B;WACOD,GAAG,IAAIA,GAAG,CAACE,eAAJ,CAAoBN,IAApB,CAAd;;;AAGJzB,MAAM,CAACsB,IAAP,GAAc,UAASU,KAAT,EAAgBX,OAAhB,EAAyB;QAC/BY,OAAO,GAAG5B,CAAC,CAAC6B,MAAF,CACV;QACIC,UAAU,EAAEC,MAAM,CAACC,iBAAP,CAAyBC,MADzC;QAEIC,kBAAkB,EAAE,IAFxB;QAGIC,gBAAgB,EAAE;KAJZ,EAMVtC,SANU,CAAd;;IAQAuC,MAAM,CAACC,IAAP,CAAY,IAAZ,EAAkBT,OAAlB,EAA2BD,KAA3B,EAAkCX,OAAlC;CATJ;;AAYArB,MAAM,CAACuB,IAAP,GAAc,UAASS,KAAT,EAAgBX,OAAhB,EAAyB;QAC/BY,OAAO,GAAG5B,CAAC,CAAC6B,MAAF,CACV;QACIC,UAAU,EAAEC,MAAM,CAACC,iBAAP,CAAyBM;KAF/B,EAIVzC,SAJU,CAAd;;IAMAuC,MAAM,CAACC,IAAP,CAAY,IAAZ,EAAkBT,OAAlB,EAA2BD,KAA3B,EAAkCX,OAAlC;CAPJ;;AAUA,SAASoB,MAAT,CAAgBR,OAAhB,EAAyBD,KAAzB,EAAgCX,OAAhC,EAAyC;QACjC,OAAOW,KAAP,KAAiB,QAAjB,IAA6B,CAACX,OAAlC,EAA2C;QACvCW,KAAK,GAAG3B,CAAC,CAAC,IAAD,CAAD,CAAQqB,IAAR,CAAa,UAAb,CAAR;;YACI,CAACM,KAAL,EAAY;;;;QAGZX,OAAO,GAAGf,GAAG,CAACsC,UAAJ,CAAeC,IAAf,CAAoB,MAAMb,KAA1B,EAAiCN,IAAjC,CAAsC,YAAtC,CAAV;;;IAEJoB,SAAS,CAACC,MAAV,CAAiBC,UAAjB,CACI,UAAStB,IAAT,EAAe;QACXuB,IAAI,CAACvB,IAAD,EAAOM,KAAP,EAAcX,OAAd,CAAJ;KAFR,EAII,UAAS6B,GAAT,EAAc;QACVC,KAAK,CAACD,GAAD,CAAL;KALR,EAOIjB,OAPJ;;;AAWJjC,MAAM,CAACoD,YAAP;;AAAA;;;6BAAsB,iBAAe1B,IAAf;;;;;;;+BACZ1B,MAAM,CAACY,GAAP,CAAWyC,KAAX,CAAiBC,KADL;;;;+BAEKC,WAAW,CAACC,aAAZ,EAFL;;;wBAEdC,UAFc;yDAGXA,UAAU,CAACC,WAAX,CAAuB3D,kBAAkB,GAAG2B,IAA5C,CAHW;;;;;;;;KAAtB;;;;;;;AAMA1B,MAAM,CAAC2D,MAAP,GAAgB,EAAhB;;AAEA3D,MAAM,CAAC4D,SAAP,GAAmB,UAAS3D,IAAT,EAAe4D,IAAf,EAAqBC,IAArB,EAA2B9B,KAA3B,EAAkC;;QAE7CP,IAAI,GAAG;QACPxB,IAAI,EAAEA,IADC;QAEP4D,IAAI,EAAEA,IAFC;QAGP9C,IAAI,EAAE+C;KAHV;IAKA9D,MAAM,CAAC2D,MAAP,CAAc1D,IAAd,IAAsBwB,IAAtB;;QACIO,KAAJ,EAAW;QACP3B,CAAC,CAAC,MAAM2B,KAAP,CAAD,CAAe+B,GAAf,CAAmB9D,IAAnB;;CATR;;AAaA,SAASgD,IAAT,CAAcvB,IAAd,EAAoBM,KAApB,EAA2BX,OAA3B,EAAoC;IAChCd,IAAI,CAACyD,KAAL,CAAW,kBAAX;IACAhE,MAAM,CAACoD,YAAP,CAAoB1B,IAApB,EAA0BuC,IAA1B,CAA+B,UAASH,IAAT,EAAe;YACtCI,MAAM,GAAGC,IAAI,CAACC,KAAL,CAAWD,IAAI,CAACE,MAAL,KAAgB,IAA3B,CAAb;YACIpE,IAAI,GAAGI,CAAC,CAAC,MAAM2B,KAAP,CAAD,CAAe+B,GAAf,MAAwB,UAAUG,MAAV,GAAmB,MAAtD;QACAlE,MAAM,CAAC4D,SAAP,CAAiB3D,IAAjB,EAAuB,YAAvB,EAAqC6D,IAArC,EAA2C9B,KAA3C;QACAzB,IAAI,CAAC+D,IAAL;;YACIjD,OAAJ,EAAa;YACTrB,MAAM,CAACqB,OAAP,CAAeA,OAAf,EAAwByC,IAAxB;;KANR;;;AAWJ,SAASX,KAAT,CAAeD,GAAf,EAAoB;IAChB3C,IAAI,CAACyD,KAAL,CAAW,0BAA0Bd,GAArC,EAA0C,GAA1C,EAA+C;QAC3CqB,KAAK,EAAEjE,GAAG,CAACkE,yBADgC;QAE3CC,QAAQ,EAAE;KAFd;;;;;;;;;"}