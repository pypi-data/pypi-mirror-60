AUTHOR: mazgi
TITLE: &lt;mazgi.github.io ç§»è¡Œæ¸ˆ&gt;Amazon SageMakerã‚’ãã‚Œãªã‚Šã®äººæ•°ã§ä½¿ã†ã¨ãã®è¨­å®š
BASENAME: setup-amazon-sagemaker
STATUS: Publish
ALLOW COMMENTS: 1
CONVERT BREAKS: 0
DATE: 03/06/2018 00:06:04
CATEGORY: AWS
CATEGORY: SageMaker
CATEGORY: Terraform
CATEGORY: Jupyter
IMAGE: https://cdn-ak.f.st-hatena.com/images/fotolife/m/mazgi/20180305/20180305225954.png
-----
BODY:
<h1>ç§»å‹•ã—ã¾ã—ãŸ</h1>

<p><a href="https://mazgi.github.io/posts/2018.03/setup-amazon-sagemaker/">mazgi.log :: Amazon SageMaker&#x3092;&#x305D;&#x308C;&#x306A;&#x308A;&#x306E;&#x4EBA;&#x6570;&#x3067;&#x4F7F;&#x3046;&#x3068;&#x304D;&#x306E;&#x8A2D;&#x5B9A;</a></p>

<hr />

<p>AWSã®ãƒãƒãƒ¼ã‚¸ãƒ‰Jupyterã‚µãƒ¼ãƒ“ã‚¹ã§ã‚ã‚‹ã€ŒAmazon SageMakerã€ã‚’æ•°ååè¦æ¨¡ã§ä½¿ã†æ©Ÿä¼šãŒã‚ã£ãŸã®ã§ã‚¤ãƒ³ãƒ•ãƒ©çš„ã«è¨­å®šã—ãŸå†…å®¹ãªã©ã‚’æ›¸ã„ã¦ãŠãã€‚<br/>
SageMakerã§ä½•ã‚’ã—ãŸã‹ãªã©ã¯ã„ãšã‚Œã¡ã‚ƒã‚“ã¨ã—ãŸæƒ…å ±ãŒå‡ºã‚‹ã¨æ€ã†ã€‚</p>

<h1>Amazon SageMakerã¨ã¯?</h1>

<p>AWSã®WebUIã§ã½ã¡ã½ã¡ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã„ãã¨JupyterãŒèµ·å‹•ã™ã‚‹ã€ãã†ã„ã†ã‚„ã¤ã§ã™ã€‚<br/>
SageMakerã®ã‚ªãƒ•ã‚£ã‚·ãƒ£ãƒ«ã‚µã‚¤ãƒˆã¯ã“ã¡ã‚‰ã€‚
<iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Faws.amazon.com%2Fjp%2Fsagemaker%2F" title="æ©Ÿæ¢°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ã¨ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ  | AWS ã§ã® Amazon SageMaker" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"></iframe><cite class="hatena-citation"><a href="https://aws.amazon.com/jp/sagemaker/">aws.amazon.com</a></cite></p>

<h1>Amazon SageMakerã®èµ·å‹•æ–¹æ³•</h1>

<p>ã¾ãšã‚¢ã‚¯ã‚»ã‚¹ã™ã¹ãã¯ã“ã¡ã‚‰ã€‚
<a href="https://console.aws.amazon.com/sagemaker/home#/notebook-instances">https://console.aws.amazon.com/sagemaker/home#/notebook-instances</a></p>

<p>ã€ŒCreate notebook instanceã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã“ã®ã‚ˆã†ãªç”»é¢ã«ãªã‚‹ã®ã§é …ç›®ã‚’åŸ‹ã‚ã¦ã„ãã€‚
<span itemscope itemtype="http://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/m/mazgi/20180305/20180305225954.png" alt="f:id:mazgi:20180305225954p:plain" title="f:id:mazgi:20180305225954p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<p>ã‚ã‚‹ç¨‹åº¦ã®äººæ•°ã§ä½¿ã†å ´åˆã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªé …ç›®ã‚’å–ã‚Šæ±ºã‚ã¦ãŠãã¨è‰¯ã•ãã†ã€‚</p>

<ul>
<li>Notebook instance name

<ul>
<li>æ–‡å­—é€šã‚ŠNotebookã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®åå‰ã«ãªã‚‹ã»ã‹ã€Jupyter Notebookã®URLã®ä¸€éƒ¨ã¨ã—ã¦ã‚‚ä½¿ã‚ã‚Œã‚‹</li>
<li>èª°ãŒä½œã£ãŸã‹ã¨ã‹ä½•ã®ç›®çš„ãªã®ã‹ã¨ã‹å‘½åãƒ«ãƒ¼ãƒ«ã‚’æ±ºã‚ã¦ãŠãã¨è‰¯ã•ãã†</li>
</ul>
</li>
<li>Notebook instance type

<ul>
<li>ã„ãã¤ã‹é¸ã¹ã‚‹</li>
<li>Notebookã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯ç´”ç²‹ã«Notebookã§ã‚ã£ã¦ã€ã“ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§jobãŒå‹•ãã‚ã‘ã§ã¯ãªã„ã®ã§ãã‚“ãªã«å¼·åŠ›ãªã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§ãªãã¦ã‚‚ã‚ˆã„</li>
<li>ãªãŠå®Ÿéš›ã«jobã‚’å®Ÿè¡Œã™ã‚‹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§ã¯ p2/p3 ãªã©ã®GPUã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚‚é¸ã¹ã‚‹</li>
</ul>
</li>
<li>IAM role(å¾Œè¿°)

<ul>
<li>Notebookã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ä¸ãˆã‚‹Roleã€ã“ã®æ¨©é™ã§jobãªã©ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œã‚ã†ã¨ã™ã‚‹</li>
<li>Roleã‚’ä½œæˆã™ã‚‹ã‹æ—¢å­˜ã®Roleã‹ã‚‰é¸æŠã™ã‚‹ã‹ãªã©ãŒé¸ã¹ã‚‹</li>
<li>ãƒãƒ¼ãƒ ã‚„ã‚°ãƒ«ãƒ¼ãƒ—ã§ä½¿ã†ã®ã§ã‚ã‚Œã°ã‚ã‚‰ã‹ã˜ã‚Roleã‚’ä½œã£ã¦ãŠã„ã¦ARNã‚’å…¥åŠ›ã—ã¦ã‚‚ã‚‰ã†æ–¹ãŒç®¡ç†ä¸Šã‚ˆã„ã¨æ€ã†</li>
</ul>
</li>
<li>Custom IAM role ARN

<ul>
<li>å‰è¿°ã®ã€ŒIAM roleã€ã§æ—¢å­˜ã®Roleã‚’é¸ã¶ã“ã¨ã«ã™ã‚‹ã¨è¡¨ç¤ºã•ã‚Œã‚‹</li>
<li>ç§ã¯ã‚ã‚‰ã‹ã˜ã‚ä½œã£ã¦ãŠã„ãŸRoleã‚’å…¥åŠ›ã—ã¦ã‚‚ã‚‰ã†ã“ã¨ã«ã—ãŸ</li>
</ul>
</li>
<li>VPC

<ul>
<li>ã¨ã‚Šã‚ãˆãšä½¿ã†ã ã‘ãªã‚‰ <code>No VPC</code> ã§ã‚ˆã„</li>
<li>ã“ã“ã§æŒ‡å®šã—ãŸVPCã«SageMakerãŒã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã‚‰ã—ã„(æœªæ¤œè¨¼)</li>
<li>"Notebook instances will have internet access independent of your VPC setting."ã¨ã‚ã‚‹é€šã‚Šã€ã“ã“ã§VPCã‚’æŒ‡å®šã—ãŸã‹ã‚‰ã¨ã„ã£ã¦SageMakerã‚„Notebookã‚’ç‰¹å®šã®VPCã«é–‰ã˜è¾¼ã‚ã‚‹ã“ã¨ã¯ã§ããªã„ã®ã§æ³¨æ„</li>
</ul>
</li>
</ul>


<p>ä»¥ä¸Šã®ã‚ˆã†ãªé …ç›®ã‚’åŸ‹ã‚ã¦ã€ãƒšãƒ¼ã‚¸ä¸‹éƒ¨ã®ã€ŒCreate notebook instanceã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨Notebookã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒæº–å‚™ã•ã‚Œã‚‹ã®ã§ã€ŒInServiceã€ã«ãªã‚‹ã¾ã§æ•°åˆ†ã€œ10æ•°åˆ†ç¨‹åº¦å¾…ã¤ã€‚ <br/>
æ¡ˆå¤–æ™‚é–“ãŒã‹ã‹ã‚‹ãŒè£å´ã§ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãªã©ã‚’è¡Œãªã£ã¦ã„ã‚‹ã®ã§ã—ã‚‡ã†ã€‚</p>

<p>ã€ŒInServiceã€ã«ãªã£ãŸNotebookã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®è©³ç´°ã‚’ã¿ã‚‹ã¨å³ä¸Šã«ã€ŒOpenã€ãƒœã‚¿ãƒ³ãŒã‚ã‚‹ã®ã§ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã€‚
<span itemscope itemtype="http://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/m/mazgi/20180305/20180305230017.png" alt="f:id:mazgi:20180305230017p:plain" title="f:id:mazgi:20180305230017p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<p>ãã†ã™ã‚‹ã¨åˆ¥ã‚¿ãƒ–ã§è¦‹æ…£ã‚ŒãŸJupyter Notebookã®ç”»é¢ãŒé–‹ãã®ã§å¥½ããªã‚ˆã†ã«ä½¿ã†ã€‚
<span itemscope itemtype="http://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/m/mazgi/20180305/20180305230045.png" alt="f:id:mazgi:20180305230045p:plain" title="f:id:mazgi:20180305230045p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<p>ã“ã‚“ãªã«æ¥½ã ã¨è‡ªåˆ†ã§Jupyter Notebookç«‹ã¦ã‚‹ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ãŒãªããªã£ã¦è‰¯ã„ã§ã™ã­ã€‚</p>

<h1>IAM Role/Groupä½œæˆ</h1>

<p>ä»¥ä¸‹ã‚’ç”¨æ„ã—ãŸ</p>

<ul>
<li>IAM Role

<ul>
<li>å‰è¿°ã®ã€Notebookã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ä¸ãˆã‚‹Role</li>
<li>æœ€å°é™ <code>AmazonSageMakerFullAccess</code> ã‚’ã‚¢ã‚¿ãƒƒãƒã—ã¦ãŠã‘ã°è‰¯ã„</li>
</ul>
</li>
<li>IAM Group

<ul>
<li>ä»Šå›ã¯1ã¤ã®AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§æ•°ååãŒåŒæ™‚ã«SageMakerã‚’ä½¿ã†ãŸã‚ã€ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œã£ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç´ã¥ã‘ã‚‹ã“ã¨ã«ã—ãŸ</li>
<li>ä»¥ä¸‹ã‚’ã‚¢ã‚¿ãƒƒãƒã—ãŸ(ã‚‚ã†å°‘ã—çµã‚Šè¾¼ã‚ãã†ã§ã¯ã‚ã‚‹)

<ul>
<li><code>AmazonSageMakerFullAccess</code></li>
<li><code>AmazonEC2FullAccess</code></li>
<li><code>IAMReadOnlyAccess</code></li>
<li><code>IAMUserChangePassword</code> (ã“ã‚Œã¯é‹ç”¨ä¸Šå¿…è¦ã ã£ãŸã ã‘)</li>
</ul>
</li>
</ul>
</li>
<li>IAM User(s)

<ul>
<li>SageMakerã‚’ä½¿ã†äººå…¨å“¡åˆ†ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ‰•ã„å‡ºã—ã€å‰è¿°ã®ã‚°ãƒ«ãƒ¼ãƒ—ã«ç´ä»˜ã‘ãŸ</li>
<li>ä»Šå›ã¯åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç§ã®æ‰‹å…ƒã§ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›ã—ã€å„è‡ªåˆå›ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«å¤‰æ›´ã—ã¦ã‚‚ã‚‰ã£ãŸ</li>
</ul>
</li>
</ul>


<p>ä»¥ä¸Šã®è¨­å®šã‚’Terraformã§è¡Œã† <code>.tf</code> ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¾‹ã¯æ¬¡ã®é€šã‚Šã€‚<br/>
å†…å®¹ã¯ã»ã¼ãã®ã¾ã¾ã€å€‹ã€…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯åˆ¥é€”å¤‰æ•°ã‹ã‚‰èª­ã‚“ã§ã„ã‚‹ã€‚</p>

<p><script src="https://gist.github.com/mazgi/aebcf7cac9ed5ca5f3f1d0f69557a820.js"> </script><cite class="hatena-citation"><a href="https://gist.github.com/mazgi/aebcf7cac9ed5ca5f3f1d0f69557a820">gist.github.com</a></cite></p>

<h1>AWSãƒªã‚½ãƒ¼ã‚¹ä¸Šé™ç·©å’Œç”³è«‹</h1>

<p>AWS SAã®æ–¹ã«ã”ç›¸è«‡ã®ä¸Šã€SageMakerã‚’åˆ©ç”¨ã™ã‚‹ <code>IAM Useræ•° * n</code> ã§äº‹å‰ã«ãƒªã‚½ãƒ¼ã‚¹ä¸Šé™ã®ç·©å’Œç”³è«‹ã‚’è¡Œãªã£ãŸã€‚<br/>
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¯ã“ã¡ã‚‰ã€‚<br/>
<a href="https://docs.aws.amazon.com/ja_jp/general/latest/gr/aws_service_limits.html#limits_sagemaker">AWS &#x30B5;&#x30FC;&#x30D3;&#x30B9;&#x5236;&#x9650; - &#x30A2;&#x30DE;&#x30BE;&#x30F3; &#x30A6;&#x30A7;&#x30D6; &#x30B5;&#x30FC;&#x30D3;&#x30B9;</a></p>

<p>å†…å®¹ã¯ã–ã£ã¨æ¬¡ã®é€šã‚Šã€‚<br/>
å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒNotebookã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’1ã¤ã€å­¦ç¿’ã¨æ¨è«–ã®jobã‚’2ã¤ãšã¤å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚’æƒ³å®šã—ãŸã€‚</p>

<ul>
<li>SageMaker ã®ãƒ›ã‚¹ãƒˆ

<ul>
<li>ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æ•°: <code>IAM Useræ•° * 3</code></li>
<li>(ä½¿ç”¨ã™ã‚‹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—): <code>IAM Useræ•° * 3</code></li>
<li>ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æ•°: <code>IAM Useræ•° * 3</code>

<ul>
<li><em>ã“ã‚Œã¯ä¸è¦ã ã£ãŸã‚ˆã†ã </em></li>
</ul>
</li>
</ul>
</li>
<li>SageMaker ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°

<ul>
<li>ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æ•°: <code>IAM Useræ•° * 3</code></li>
<li>ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¸ãƒ§ãƒ–ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æ•°: <code>IAM Useræ•° * 3</code></li>
<li>(ä½¿ç”¨ã™ã‚‹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—): <code>IAM Useræ•° * 3</code></li>
</ul>
</li>
<li>SageMaker ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯

<ul>
<li>(ä½¿ç”¨ã™ã‚‹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—): <code>IAM Useræ•° * 1.5</code></li>
<li>å®Ÿè¡Œä¸­ã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®æ•°: <code>IAM Useræ•° * 1.5</code></li>
</ul>
</li>
</ul>


<p>ä¸€éƒ¨CloudTrailã®ä¸Šé™ã«å¼•ã£ã‹ã‹ã‚ŠåŒæ™‚å®Ÿè¡Œã§ããªã‹ã£ãŸã‚Šã‚‚ã—ãŸãŒã€æ¦‚ã­ã“ã‚Œã§ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¨å“¡ãŒç›®çš„ã®æ“ä½œã‚’è¡ŒãˆãŸã€‚<br/>
AWSã®ãƒªã‚½ãƒ¼ã‚¹ä¸Šé™ã¯ãªã‹ãªã‹é›£ã—ã„ã®ã§AWS SAã®æ–¹ã«ç›¸è«‡ã™ã‚‹ã«é™ã‚‹ğŸ™</p>

<h1>æ„Ÿæƒ³</h1>

<p>ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã—ã¦ãƒ«ãƒ¼ãƒ«ã‚’æ±ºã‚ã¦ãŠã‘ã°ä½¿ã„ãŸã„äººã«ã‚µã‚¯ãƒƒã¨ä½¿ã£ã¦ã‚‚ã‚‰ãˆã¦å¤§å¤‰ä¾¿åˆ©ã€‚<br/>
å„ç¨®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ‹…ä¿ã®æ–¹æ³•ã‚„è¾¼ã¿å…¥ã£ãŸä½¿ã„æ–¹ã«ã¤ã„ã¦ã¯ä»Šå¾Œä½¿ã£ã¦ã‚‚ã‚‰ã„ãªãŒã‚‰å·¥å¤«ã—ã¦ã„ããŸã„ã€‚</p>

-----
--------
AUTHOR: mazgi
TITLE: &lt;mazgi.github.io ç§»è¡Œæ¸ˆ&gt;SSE-KMSã§æš—å·åŒ–ã—ãŸS3ãƒã‚±ãƒƒãƒˆã‚’s3fsã§mountã™ã‚‹
BASENAME: s3fs-for-s3-with-sse-kms
STATUS: Publish
ALLOW COMMENTS: 1
CONVERT BREAKS: 0
DATE: 03/01/2018 04:32:56
CATEGORY: Amazon S3
CATEGORY: AWS
CATEGORY: AWS KMS
IMAGE: https://cdn-ak.f.st-hatena.com/images/fotolife/m/mazgi/20180301/20180301042415.jpg
-----
BODY:
<p>ç§»å‹•ã—ã¾ã—ãŸ=> <a href="https://mazgi.github.io/posts/2018.03/s3fs-for-s3-with-sse-kms/">mazgi.log :: SSE-KMS&#x3067;&#x6697;&#x53F7;&#x5316;&#x3057;&#x305F;S3&#x30D0;&#x30B1;&#x30C3;&#x30C8;&#x3092;s3fs&#x3067;mount&#x3059;&#x308B;</a></p>

<p>ã‚¿ã‚¤ãƒˆãƒ«ã®é€šã‚Šã€ŒAWS Key Management Service (AWS KMS) ã€ã‚’ä½¿ã£ã¦æš—å·åŒ–ã—ãŸAmazon S3ãƒã‚±ãƒƒãƒˆã‚’s3fsã§Ubuntu 16ä¸Šã§mountã—ãŸã€‚<br/>
KMSã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒè©³ã—ã„ãŒè¦ã¯æš—å·åŒ–ã®éš›ã«ç…©é›‘ãªéµã®ç®¡ç†ã‚’AWSã«ãŠé¡˜ã„ã§ãã‚‹ä»•çµ„ã¿ã€‚</p>

<p><iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fdocs.aws.amazon.com%2Fja_jp%2FAmazonS3%2Flatest%2Fdev%2FUsingKMSEncryption.html" title="AWS KMS ã§ç®¡ç†ã•ã‚ŒãŸã‚­ãƒ¼ã«ã‚ˆã‚‹ã‚µãƒ¼ãƒãƒ¼å´ã®æš—å·åŒ– (SSE-KMS) ã‚’ä½¿ç”¨ã—ãŸãƒ‡ãƒ¼ã‚¿ã®ä¿è­· - Amazon Simple Storage Service" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"></iframe><cite class="hatena-citation"><a href="https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/dev/UsingKMSEncryption.html">docs.aws.amazon.com</a></cite></p>

<h1>S3ãƒã‚±ãƒƒãƒˆã®æº–å‚™</h1>

<p>S3ãƒã‚±ãƒƒãƒˆã‚’ä½œã‚Šã€ç”»åƒã®ã‚ˆã†ã« <code>Default encryption</code> ã‚’ <code>AWS-KMS</code> ã«è¨­å®šã™ã‚‹ã€‚<br/>
ãªãŠã“ã®S3ãƒã‚±ãƒƒãƒˆã¯è¨˜äº‹å…¬é–‹æ™‚ç‚¹ã§å‰Šé™¤æ¸ˆã¿ã€‚</p>

<p><span itemscope itemtype="http://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/m/mazgi/20180301/20180301035936.png" alt="f:id:mazgi:20180301035936p:plain" title="f:id:mazgi:20180301035936p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<h1>s3fsã®è¨­å®š</h1>

<h2>Install</h2>

<p>GitHubã‹ã‚‰ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦</p>

<pre class="code" data-lang="" data-unlink>$ ./autogen.sh
$ ./configure
$ make
$ sudo make install</pre>


<p>ã™ã‚‹ã€‚</p>

<p><iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fgithub.com%2Fs3fs-fuse%2Fs3fs-fuse%2Freleases%2Ftag%2Fv1.83" title="s3fs-fuse/s3fs-fuse" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"></iframe><cite class="hatena-citation"><a href="https://github.com/s3fs-fuse/s3fs-fuse/releases/tag/v1.83">github.com</a></cite></p>

<h2>mount</h2>

<p>ä»¥ä¸‹ã®ã‚ˆã†ã«AWSã®credentialã‚’ <code>.secret</code> ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã« <code>ACCESS_KEY:SECRET_KEY</code> ã¨ã„ã†ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§æ›¸ãã€‚<br/>
ã¾ãŸKMSã®éµIDã‚’ç’°å¢ƒå¤‰æ•°ã«è¨­å®šã—ãŸã€‚</p>

<pre class="code" data-lang="" data-unlink>$ cat .secret
****ACCESS_KEY****:****SECRET_KEY****
$ export AWSSSEKMSID=&#39;********&#39;</pre>


<p>ãã—ã¦mountã™ã‚‹ã€‚<br/>
<code>endpoint</code>, <code>uid</code>, <code>gid</code> , <code>umask</code> ã‚ãŸã‚Šã‚’ãã¡ã‚“ã¨è¨­å®šã—ãªã„ã¨èª­ã¿æ›¸ãã§ããªã„ã€ãƒãƒã£ãŸã€‚<br/>
ãªãŠéµIDã¯ç’°å¢ƒå¤‰æ•°ä½¿ã‚ãªãã¦ã‚‚ <code>use_sse=kmsid:"${AWSSSEKMSID}"</code> ã§ã„ã‘ã‚‹æ¨¡æ§˜ã€‚</p>

<p>ã¾ãŸ <code>-d</code> ã¯debugã€ <code>-f</code> ã¯ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å®Ÿè¡Œã€‚</p>

<pre class="code" data-lang="" data-unlink>$ s3fs mazgi-s3-sse-kms-test-01-bucket-01 bucket -o passwd_file=.secret,use_sse=kmsid,endpoint=ap-northeast-1,allow_other,uid=1234,gid=1234,umask=227 -d -f
[CRT] s3fs.cpp:set_s3fs_log_level(271): change debug level from [CRT] to [INF] 
[INF]     s3fs.cpp:set_mountpoint_attribute(4206): PROC(uid=4600, gid=4600) - MountPoint(uid=4600, gid=4600, mode=40775)
[INF] s3fs.cpp:s3fs_init(3371): init v1.83(commit:unknown) with OpenSSL
[INF] s3fs.cpp:s3fs_check_service(3747): check services.
[INF]       curl.cpp:CheckBucket(3068): check a bucket.
[INF]       curl.cpp:prepare_url(4253): URL is https://s3.amazonaws.com/mazgi-s3-sse-kms-test-01-bucket-01/
[INF]       curl.cpp:prepare_url(4285): URL changed is https://mazgi-s3-sse-kms-test-01-bucket-01.s3.amazonaws.com/
[INF]       curl.cpp:insertV4Headers(2400): computing signature [GET] [/] [] []
[INF]       curl.cpp:url_to_host(101): url is https://s3.amazonaws.com
[INF]       curl.cpp:RequestPerform(2051): HTTP response code 200</pre>


<h2>ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œ</h2>

<p><code>ls</code> ã—ã¦ã¿ã‚‹ã€‚</p>

<p>ãªãŠS3ãƒã‚±ãƒƒãƒˆã«å…¥ã£ã¦ã„ã‚‹JPEGç”»åƒã¯ã“ã‚Œã€‚ã‹ã‚ã„ã„ã€‚<br/>
ã€Œ<a href="https://www.pakutaso.com/">ã±ããŸã</a>ã€ã‹ã‚‰ãŠå€Ÿã‚Šã—ãŸã€‚</p>

<p><span itemscope itemtype="http://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/m/mazgi/20180301/20180301042415.jpg" alt="f:id:mazgi:20180301042415j:plain" title="f:id:mazgi:20180301042415j:plain" class="hatena-fotolife" itemprop="image"></span></p>

<pre class="code" data-lang="" data-unlink>$ ls -l bucket
total 179
-r-xr-x--- 1 user group 96870 Feb  1 07:10 cat.jpg*
-r-xr-x--- 1 user group 84999 Feb  1 07:13 cat_plain.jpg*</pre>


<p>ãã®æ™‚ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã€‚</p>

<pre class="code" data-lang="" data-unlink>[INF] s3fs.cpp:s3fs_getattr(841): [path=/]
[INF] s3fs.cpp:s3fs_opendir(2281): [path=/][flags=100352]
[INF] s3fs.cpp:s3fs_readdir(2432): [path=/]
[INF]   s3fs.cpp:list_bucket(2477): [path=/]
[INF]       curl.cpp:ListBucketRequest(3103): [tpath=/]
[INF]       curl.cpp:prepare_url(4253): URL is https://s3.amazonaws.com/mazgi-s3-sse-kms-test-01-bucket-01?delimiter=/&amp;max-keys=1000&amp;prefix=
[INF]       curl.cpp:prepare_url(4285): URL changed is https://mazgi-s3-sse-kms-test-01-bucket-01.s3.amazonaws.com?delimiter=/&amp;max-keys=1000&amp;prefix=
[INF]       curl.cpp:insertV4Headers(2400): computing signature [GET] [/] [delimiter=/&amp;max-keys=1000&amp;prefix=] []
[INF]       curl.cpp:url_to_host(101): url is https://s3.amazonaws.com
[INF]       curl.cpp:RequestPerform(2051): HTTP response code 200
[WAN] s3fs.cpp:append_objects_from_xml_ex(2575): contents_xp-&gt;nodesetval is empty.
[INF]   s3fs.cpp:readdir_multi_head(2346): [path=/][list=0]
[INF]       curl.cpp:PreHeadRequest(2657): [tpath=/cat.jpg][bpath=cat.jpg][save=/cat.jpg][sseckeypos=-1]
[INF]       curl.cpp:prepare_url(4253): URL is https://s3.amazonaws.com/mazgi-s3-sse-kms-test-01-bucket-01/cat.jpg
[INF]       curl.cpp:prepare_url(4285): URL changed is https://mazgi-s3-sse-kms-test-01-bucket-01.s3.amazonaws.com/cat.jpg
[INF]       curl.cpp:insertV4Headers(2400): computing signature [HEAD] [/cat.jpg] [] []
[INF]       curl.cpp:url_to_host(101): url is https://s3.amazonaws.com
[INF]       curl.cpp:PreHeadRequest(2657): [tpath=/cat_plain.jpg][bpath=cat_plain.jpg][save=/cat_plain.jpg][sseckeypos=-1]
[INF]       curl.cpp:prepare_url(4253): URL is https://s3.amazonaws.com/mazgi-s3-sse-kms-test-01-bucket-01/cat_plain.jpg
[INF]       curl.cpp:prepare_url(4285): URL changed is https://mazgi-s3-sse-kms-test-01-bucket-01.s3.amazonaws.com/cat_plain.jpg
[INF]       curl.cpp:insertV4Headers(2400): computing signature [HEAD] [/cat_plain.jpg] [] []
[INF]       curl.cpp:url_to_host(101): url is https://s3.amazonaws.com
[INF]       curl.cpp:Request(3999): [count=2]
[INF]       curl.cpp:RequestPerform(2051): HTTP response code 200
[INF]       curl.cpp:RequestPerform(2051): HTTP response code 200
[INF]       cache.cpp:AddStat(356): add stat cache entry[path=/cat_plain.jpg]
[INF]       cache.cpp:AddStat(356): add stat cache entry[path=/cat.jpg]
[INF] s3fs.cpp:s3fs_getattr(841): [path=/cat.jpg]
[INF] s3fs.cpp:s3fs_getattr(841): [path=/cat_plain.jpg]</pre>


<p>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‰ã®ãƒã‚§ãƒƒã‚¯ã‚µãƒ ãŒã“ã‚Œã€‚</p>

<pre class="code" data-lang="" data-unlink>$ shasum -a 1 cat.jpg
fb9f3c47ad3d91ced2e62c82f0ae753330351b32  cat.jpg</pre>


<p>mountã—ãŸS3ãƒã‚±ãƒƒãƒˆã‹ã‚‰èª­ã¿å–ã‚Šãƒ†ã‚¹ãƒˆå…¼ã­ã¦ãƒã‚§ãƒƒã‚¯ã‚µãƒ ã‚’å–å¾—ã—ã¦ã¿ã‚‹ã€‚<br/>
ä¸€è‡´ã—ã¦ã„ã‚‹ã®ã§æ­£ã—ãèª­ã¿å–ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚‹ã€‚</p>

<pre class="code" data-lang="" data-unlink>$ sha1sum bucket/cat.jpg
fb9f3c47ad3d91ced2e62c82f0ae753330351b32  bucket/cat.jpg</pre>


<p>ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿å–ã‚Šæ™‚ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã€‚</p>

<pre class="code" data-lang="" data-unlink>[INF] s3fs.cpp:s3fs_getattr(841): [path=/cat.jpg]
[INF] s3fs.cpp:s3fs_open(2063): [path=/cat.jpg][flags=32768]
[INF]       cache.cpp:DelStat(565): delete stat cache entry[path=/cat.jpg]
[INF]       curl.cpp:HeadRequest(2708): [tpath=/cat.jpg]
[INF]       curl.cpp:PreHeadRequest(2657): [tpath=/cat.jpg][bpath=][save=][sseckeypos=-1]
[INF]       curl.cpp:prepare_url(4253): URL is https://s3.amazonaws.com/mazgi-s3-sse-kms-test-01-bucket-01/cat.jpg
[INF]       curl.cpp:prepare_url(4285): URL changed is https://mazgi-s3-sse-kms-test-01-bucket-01.s3.amazonaws.com/cat.jpg
[INF]       curl.cpp:insertV4Headers(2400): computing signature [HEAD] [/cat.jpg] [] []
[INF]       curl.cpp:url_to_host(101): url is https://s3.amazonaws.com
[INF]       curl.cpp:RequestPerform(2051): HTTP response code 200
[INF]       cache.cpp:AddStat(356): add stat cache entry[path=/cat.jpg]
[INF]       fdcache.cpp:SetMtime(1019): [path=/cat.jpg][fd=7][time=1517436613]
[INF]       curl.cpp:GetObjectRequest(3043): [tpath=/cat.jpg][start=0][size=96870]
[INF]       curl.cpp:PreGetObjectRequest(2983): [tpath=/cat.jpg][start=0][size=96870]
[INF]       curl.cpp:prepare_url(4253): URL is https://s3.amazonaws.com/mazgi-s3-sse-kms-test-01-bucket-01/cat.jpg
[INF]       curl.cpp:prepare_url(4285): URL changed is https://mazgi-s3-sse-kms-test-01-bucket-01.s3.amazonaws.com/cat.jpg
[INF]       curl.cpp:insertV4Headers(2400): computing signature [GET] [/cat.jpg] [] []
[INF]       curl.cpp:url_to_host(101): url is https://s3.amazonaws.com
[INF]       curl.cpp:GetObjectRequest(3058): downloading... [path=/cat.jpg][fd=7]
[INF]       curl.cpp:RequestPerform(2051): HTTP response code 206
[INF] s3fs.cpp:s3fs_getattr(841): [path=/cat.jpg]
[INF] s3fs.cpp:s3fs_flush(2185): [path=/cat.jpg][fd=7]
[INF]       fdcache.cpp:RowFlush(1434): [tpath=][path=/cat.jpg][fd=7]
[INF] s3fs.cpp:s3fs_release(2238): [path=/cat.jpg][fd=7]
[INF]       fdcache.cpp:GetFdEntity(1995): [path=/cat.jpg][fd=7]</pre>


<p>ä»Šåº¦ã¯S3ãƒã‚±ãƒƒãƒˆã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›¸ãè¾¼ã‚“ã§ã¿ã‚‹ã€‚<br/>
é©å½“ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚Šãƒã‚§ãƒƒã‚¯ã‚µãƒ ã‚’å–å¾—ã€‚</p>

<pre class="code" data-lang="" data-unlink>$ head -1 /dev/urandom|od -x &gt; rand.txt
$ sha1sum rand.txt
bb02ee0d5fc5b459ca1978fcc0e53649d144554c  rand.txt</pre>


<p>ãƒã‚¦ãƒ³ãƒˆãƒã‚¤ãƒ³ãƒˆã«ã‚³ãƒ”ãƒ¼ã™ã‚‹ã€‚<br/>
ã‚³ãƒ”ãƒ¼å¾Œã®ãƒã‚§ãƒƒã‚¯ã‚µãƒ ãŒä¸€è‡´ã—ã¦ã„ã‚‹ã®ã§æ­£ã—ãã‚³ãƒ”ãƒ¼ã§ããŸã“ã¨ãŒã‚ã‹ã‚‹ã€‚</p>

<pre class="code" data-lang="" data-unlink>$ cp rand.txt bucket/
$ sha1sum bucket/rand.txt
bb02ee0d5fc5b459ca1978fcc0e53649d144554c  bucket/rand.txt</pre>


<p>æ›¸ãè¾¼ã¿æ™‚ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã€‚</p>

<pre class="code" data-lang="" data-unlink>[INF] s3fs.cpp:s3fs_getattr(841): [path=/]
[INF] s3fs.cpp:s3fs_getattr(841): [path=/rand.txt]
[INF]       curl.cpp:HeadRequest(2708): [tpath=/rand.txt]
[INF]       curl.cpp:PreHeadRequest(2657): [tpath=/rand.txt][bpath=][save=][sseckeypos=-1]
[INF]       curl.cpp:prepare_url(4253): URL is https://s3.amazonaws.com/mazgi-s3-sse-kms-test-01-bucket-01/rand.txt
[INF]       curl.cpp:prepare_url(4285): URL changed is https://mazgi-s3-sse-kms-test-01-bucket-01.s3.amazonaws.com/rand.txt
[INF]       curl.cpp:insertV4Headers(2400): computing signature [HEAD] [/rand.txt] [] []
[INF]       curl.cpp:url_to_host(101): url is https://s3.amazonaws.com
[INF]       curl.cpp:RequestPerform(2073): HTTP response code 404 was returned, returning ENOENT
[INF]       curl.cpp:HeadRequest(2708): [tpath=/rand.txt/]
[INF]       curl.cpp:PreHeadRequest(2657): [tpath=/rand.txt/][bpath=][save=][sseckeypos=-1]
[INF]       curl.cpp:prepare_url(4253): URL is https://s3.amazonaws.com/mazgi-s3-sse-kms-test-01-bucket-01/rand.txt/
[INF]       curl.cpp:prepare_url(4285): URL changed is https://mazgi-s3-sse-kms-test-01-bucket-01.s3.amazonaws.com/rand.txt/
[INF]       curl.cpp:insertV4Headers(2400): computing signature [HEAD] [/rand.txt/] [] []
[INF]       curl.cpp:url_to_host(101): url is https://s3.amazonaws.com
[INF]       curl.cpp:RequestPerform(2073): HTTP response code 404 was returned, returning ENOENT
[INF]       curl.cpp:HeadRequest(2708): [tpath=/rand.txt_$folder$]
[INF]       curl.cpp:PreHeadRequest(2657): [tpath=/rand.txt_$folder$][bpath=][save=][sseckeypos=-1]
[INF]       curl.cpp:prepare_url(4253): URL is https://s3.amazonaws.com/mazgi-s3-sse-kms-test-01-bucket-01/rand.txt_%24folder%24
[INF]       curl.cpp:prepare_url(4285): URL changed is https://mazgi-s3-sse-kms-test-01-bucket-01.s3.amazonaws.com/rand.txt_%24folder%24
[INF]       curl.cpp:insertV4Headers(2400): computing signature [HEAD] [/rand.txt_$folder$] [] []
[INF]       curl.cpp:url_to_host(101): url is https://s3.amazonaws.com
[INF]       curl.cpp:RequestPerform(2073): HTTP response code 404 was returned, returning ENOENT
[INF]   s3fs.cpp:list_bucket(2477): [path=/rand.txt]
[INF]       curl.cpp:ListBucketRequest(3103): [tpath=/rand.txt]
[INF]       curl.cpp:prepare_url(4253): URL is https://s3.amazonaws.com/mazgi-s3-sse-kms-test-01-bucket-01?delimiter=/&amp;max-keys=2&amp;prefix=rand.txt/
[INF]       curl.cpp:prepare_url(4285): URL changed is https://mazgi-s3-sse-kms-test-01-bucket-01.s3.amazonaws.com?delimiter=/&amp;max-keys=2&amp;prefix=rand.txt/
[INF]       curl.cpp:insertV4Headers(2400): computing signature [GET] [/] [delimiter=/&amp;max-keys=2&amp;prefix=rand.txt/] []
[INF]       curl.cpp:url_to_host(101): url is https://s3.amazonaws.com
[INF]       curl.cpp:RequestPerform(2051): HTTP response code 200
[WAN] s3fs.cpp:append_objects_from_xml_ex(2575): contents_xp-&gt;nodesetval is empty.
[WAN] s3fs.cpp:append_objects_from_xml_ex(2575): contents_xp-&gt;nodesetval is empty.
[INF] s3fs.cpp:s3fs_getattr(841): [path=/rand.txt]
[INF]       curl.cpp:HeadRequest(2708): [tpath=/rand.txt]
[INF]       curl.cpp:PreHeadRequest(2657): [tpath=/rand.txt][bpath=][save=][sseckeypos=-1]
[INF]       curl.cpp:prepare_url(4253): URL is https://s3.amazonaws.com/mazgi-s3-sse-kms-test-01-bucket-01/rand.txt
[INF]       curl.cpp:prepare_url(4285): URL changed is https://mazgi-s3-sse-kms-test-01-bucket-01.s3.amazonaws.com/rand.txt
[INF]       curl.cpp:insertV4Headers(2400): computing signature [HEAD] [/rand.txt] [] []
[INF]       curl.cpp:url_to_host(101): url is https://s3.amazonaws.com
[INF]       curl.cpp:RequestPerform(2073): HTTP response code 404 was returned, returning ENOENT
[INF]       curl.cpp:HeadRequest(2708): [tpath=/rand.txt/]
[INF]       curl.cpp:PreHeadRequest(2657): [tpath=/rand.txt/][bpath=][save=][sseckeypos=-1]
[INF]       curl.cpp:prepare_url(4253): URL is https://s3.amazonaws.com/mazgi-s3-sse-kms-test-01-bucket-01/rand.txt/
[INF]       curl.cpp:prepare_url(4285): URL changed is https://mazgi-s3-sse-kms-test-01-bucket-01.s3.amazonaws.com/rand.txt/
[INF]       curl.cpp:insertV4Headers(2400): computing signature [HEAD] [/rand.txt/] [] []
[INF]       curl.cpp:url_to_host(101): url is https://s3.amazonaws.com
[INF]       curl.cpp:RequestPerform(2073): HTTP response code 404 was returned, returning ENOENT
[INF]       curl.cpp:HeadRequest(2708): [tpath=/rand.txt_$folder$]
[INF]       curl.cpp:PreHeadRequest(2657): [tpath=/rand.txt_$folder$][bpath=][save=][sseckeypos=-1]
[INF]       curl.cpp:prepare_url(4253): URL is https://s3.amazonaws.com/mazgi-s3-sse-kms-test-01-bucket-01/rand.txt_%24folder%24
[INF]       curl.cpp:prepare_url(4285): URL changed is https://mazgi-s3-sse-kms-test-01-bucket-01.s3.amazonaws.com/rand.txt_%24folder%24
[INF]       curl.cpp:insertV4Headers(2400): computing signature [HEAD] [/rand.txt_$folder$] [] []
[INF]       curl.cpp:url_to_host(101): url is https://s3.amazonaws.com
[INF]       curl.cpp:RequestPerform(2073): HTTP response code 404 was returned, returning ENOENT
[INF]   s3fs.cpp:list_bucket(2477): [path=/rand.txt]
[INF]       curl.cpp:ListBucketRequest(3103): [tpath=/rand.txt]
[INF]       curl.cpp:prepare_url(4253): URL is https://s3.amazonaws.com/mazgi-s3-sse-kms-test-01-bucket-01?delimiter=/&amp;max-keys=2&amp;prefix=rand.txt/
[INF]       curl.cpp:prepare_url(4285): URL changed is https://mazgi-s3-sse-kms-test-01-bucket-01.s3.amazonaws.com?delimiter=/&amp;max-keys=2&amp;prefix=rand.txt/
[INF]       curl.cpp:insertV4Headers(2400): computing signature [GET] [/] [delimiter=/&amp;max-keys=2&amp;prefix=rand.txt/] []
[INF]       curl.cpp:url_to_host(101): url is https://s3.amazonaws.com
[INF]       curl.cpp:RequestPerform(2051): HTTP response code 200
[WAN] s3fs.cpp:append_objects_from_xml_ex(2575): contents_xp-&gt;nodesetval is empty.
[WAN] s3fs.cpp:append_objects_from_xml_ex(2575): contents_xp-&gt;nodesetval is empty.
[INF] s3fs.cpp:s3fs_create(999): [path=/rand.txt][mode=100664][flags=32961]
[INF]       curl.cpp:HeadRequest(2708): [tpath=/rand.txt]
[INF]       curl.cpp:PreHeadRequest(2657): [tpath=/rand.txt][bpath=][save=][sseckeypos=-1]
[INF]       curl.cpp:prepare_url(4253): URL is https://s3.amazonaws.com/mazgi-s3-sse-kms-test-01-bucket-01/rand.txt
[INF]       curl.cpp:prepare_url(4285): URL changed is https://mazgi-s3-sse-kms-test-01-bucket-01.s3.amazonaws.com/rand.txt
[INF]       curl.cpp:insertV4Headers(2400): computing signature [HEAD] [/rand.txt] [] []
[INF]       curl.cpp:url_to_host(101): url is https://s3.amazonaws.com
[INF]       curl.cpp:RequestPerform(2073): HTTP response code 404 was returned, returning ENOENT
[INF]       curl.cpp:HeadRequest(2708): [tpath=/rand.txt/]
[INF]       curl.cpp:PreHeadRequest(2657): [tpath=/rand.txt/][bpath=][save=][sseckeypos=-1]
[INF]       curl.cpp:prepare_url(4253): URL is https://s3.amazonaws.com/mazgi-s3-sse-kms-test-01-bucket-01/rand.txt/
[INF]       curl.cpp:prepare_url(4285): URL changed is https://mazgi-s3-sse-kms-test-01-bucket-01.s3.amazonaws.com/rand.txt/
[INF]       curl.cpp:insertV4Headers(2400): computing signature [HEAD] [/rand.txt/] [] []
[INF]       curl.cpp:url_to_host(101): url is https://s3.amazonaws.com
[INF]       curl.cpp:RequestPerform(2073): HTTP response code 404 was returned, returning ENOENT
[INF]       curl.cpp:HeadRequest(2708): [tpath=/rand.txt_$folder$]
[INF]       curl.cpp:PreHeadRequest(2657): [tpath=/rand.txt_$folder$][bpath=][save=][sseckeypos=-1]
[INF]       curl.cpp:prepare_url(4253): URL is https://s3.amazonaws.com/mazgi-s3-sse-kms-test-01-bucket-01/rand.txt_%24folder%24
[INF]       curl.cpp:prepare_url(4285): URL changed is https://mazgi-s3-sse-kms-test-01-bucket-01.s3.amazonaws.com/rand.txt_%24folder%24
[INF]       curl.cpp:insertV4Headers(2400): computing signature [HEAD] [/rand.txt_$folder$] [] []
[INF]       curl.cpp:url_to_host(101): url is https://s3.amazonaws.com
[INF]       curl.cpp:RequestPerform(2073): HTTP response code 404 was returned, returning ENOENT
[INF]   s3fs.cpp:list_bucket(2477): [path=/rand.txt]
[INF]       curl.cpp:ListBucketRequest(3103): [tpath=/rand.txt]
[INF]       curl.cpp:prepare_url(4253): URL is https://s3.amazonaws.com/mazgi-s3-sse-kms-test-01-bucket-01?delimiter=/&amp;max-keys=2&amp;prefix=rand.txt/
[INF]       curl.cpp:prepare_url(4285): URL changed is https://mazgi-s3-sse-kms-test-01-bucket-01.s3.amazonaws.com?delimiter=/&amp;max-keys=2&amp;prefix=rand.txt/
[INF]       curl.cpp:insertV4Headers(2400): computing signature [GET] [/] [delimiter=/&amp;max-keys=2&amp;prefix=rand.txt/] []
[INF]       curl.cpp:url_to_host(101): url is https://s3.amazonaws.com
[INF]       curl.cpp:RequestPerform(2051): HTTP response code 200
[WAN] s3fs.cpp:append_objects_from_xml_ex(2575): contents_xp-&gt;nodesetval is empty.
[WAN] s3fs.cpp:append_objects_from_xml_ex(2575): contents_xp-&gt;nodesetval is empty.
[INF]     s3fs.cpp:create_file_object(960): [path=/rand.txt][mode=100664]
[INF]       curl.cpp:PutRequest(2872): [tpath=/rand.txt]
[INF]       curl.cpp:PutRequest(2889): create zero byte file object.
[INF]       curl.cpp:prepare_url(4253): URL is https://s3.amazonaws.com/mazgi-s3-sse-kms-test-01-bucket-01/rand.txt
[INF]       curl.cpp:prepare_url(4285): URL changed is https://mazgi-s3-sse-kms-test-01-bucket-01.s3.amazonaws.com/rand.txt
[INF]       curl.cpp:insertV4Headers(2400): computing signature [PUT] [/rand.txt] [] []
[INF]       curl.cpp:url_to_host(101): url is https://s3.amazonaws.com
[INF]       curl.cpp:PutRequest(2969): uploading... [path=/rand.txt][fd=-1][size=0]
[INF]       curl.cpp:RequestPerform(2051): HTTP response code 200
[INF]       cache.cpp:DelStat(565): delete stat cache entry[path=/rand.txt]
[INF]       curl.cpp:HeadRequest(2708): [tpath=/rand.txt]
[INF]       curl.cpp:PreHeadRequest(2657): [tpath=/rand.txt][bpath=][save=][sseckeypos=-1]
[INF]       curl.cpp:prepare_url(4253): URL is https://s3.amazonaws.com/mazgi-s3-sse-kms-test-01-bucket-01/rand.txt
[INF]       curl.cpp:prepare_url(4285): URL changed is https://mazgi-s3-sse-kms-test-01-bucket-01.s3.amazonaws.com/rand.txt
[INF]       curl.cpp:insertV4Headers(2400): computing signature [HEAD] [/rand.txt] [] []
[INF]       curl.cpp:url_to_host(101): url is https://s3.amazonaws.com
[INF]       curl.cpp:RequestPerform(2051): HTTP response code 200
[INF]       cache.cpp:AddStat(356): add stat cache entry[path=/rand.txt]
[INF] s3fs.cpp:s3fs_getattr(841): [path=/rand.txt]
[INF] s3fs.cpp:s3fs_flush(2185): [path=/rand.txt][fd=7]
[INF]       fdcache.cpp:RowFlush(1434): [tpath=][path=/rand.txt][fd=7]
[INF]       curl.cpp:PutRequest(2872): [tpath=/rand.txt]
[INF]       curl.cpp:prepare_url(4253): URL is https://s3.amazonaws.com/mazgi-s3-sse-kms-test-01-bucket-01/rand.txt
[INF]       curl.cpp:prepare_url(4285): URL changed is https://mazgi-s3-sse-kms-test-01-bucket-01.s3.amazonaws.com/rand.txt
[INF]       curl.cpp:insertV4Headers(2400): computing signature [PUT] [/rand.txt] [] [2a5b392dff6867a115948ff04fbec762a6f007cffebf40544c62308ec9eab099]
[INF]       curl.cpp:url_to_host(101): url is https://s3.amazonaws.com
[INF]       curl.cpp:PutRequest(2969): uploading... [path=/rand.txt][fd=7][size=996]
[INF]       curl.cpp:RequestPerform(2051): HTTP response code 200
[INF] s3fs.cpp:s3fs_release(2238): [path=/rand.txt][fd=7]
[INF]       cache.cpp:DelStat(565): delete stat cache entry[path=/rand.txt]
[INF]       fdcache.cpp:GetFdEntity(1995): [path=/rand.txt][fd=7]</pre>


<p>ã“ã¡ã‚‰ã¯ãƒã‚§ãƒƒã‚¯ã‚µãƒ å–å¾—æ™‚ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã€‚</p>

<pre class="code" data-lang="" data-unlink>[INF] s3fs.cpp:s3fs_getattr(841): [path=/rand.txt]
[INF]       curl.cpp:HeadRequest(2708): [tpath=/rand.txt]
[INF]       curl.cpp:PreHeadRequest(2657): [tpath=/rand.txt][bpath=][save=][sseckeypos=-1]
[INF]       curl.cpp:prepare_url(4253): URL is https://s3.amazonaws.com/mazgi-s3-sse-kms-test-01-bucket-01/rand.txt
[INF]       curl.cpp:prepare_url(4285): URL changed is https://mazgi-s3-sse-kms-test-01-bucket-01.s3.amazonaws.com/rand.txt
[INF]       curl.cpp:insertV4Headers(2400): computing signature [HEAD] [/rand.txt] [] []
[INF]       curl.cpp:url_to_host(101): url is https://s3.amazonaws.com
[INF]       curl.cpp:RequestPerform(2051): HTTP response code 200
[INF]       cache.cpp:AddStat(356): add stat cache entry[path=/rand.txt]
[INF] s3fs.cpp:s3fs_open(2063): [path=/rand.txt][flags=32768]
[INF]       cache.cpp:DelStat(565): delete stat cache entry[path=/rand.txt]
[INF]       curl.cpp:HeadRequest(2708): [tpath=/rand.txt]
[INF]       curl.cpp:PreHeadRequest(2657): [tpath=/rand.txt][bpath=][save=][sseckeypos=-1]
[INF]       curl.cpp:prepare_url(4253): URL is https://s3.amazonaws.com/mazgi-s3-sse-kms-test-01-bucket-01/rand.txt
[INF]       curl.cpp:prepare_url(4285): URL changed is https://mazgi-s3-sse-kms-test-01-bucket-01.s3.amazonaws.com/rand.txt
[INF]       curl.cpp:insertV4Headers(2400): computing signature [HEAD] [/rand.txt] [] []
[INF]       curl.cpp:url_to_host(101): url is https://s3.amazonaws.com
[INF]       curl.cpp:RequestPerform(2051): HTTP response code 200
[INF]       cache.cpp:AddStat(356): add stat cache entry[path=/rand.txt]
[INF]       fdcache.cpp:SetMtime(1019): [path=/rand.txt][fd=7][time=1517862525]
[INF]       curl.cpp:GetObjectRequest(3043): [tpath=/rand.txt][start=0][size=996]
[INF]       curl.cpp:PreGetObjectRequest(2983): [tpath=/rand.txt][start=0][size=996]
[INF]       curl.cpp:prepare_url(4253): URL is https://s3.amazonaws.com/mazgi-s3-sse-kms-test-01-bucket-01/rand.txt
[INF]       curl.cpp:prepare_url(4285): URL changed is https://mazgi-s3-sse-kms-test-01-bucket-01.s3.amazonaws.com/rand.txt
[INF]       curl.cpp:insertV4Headers(2400): computing signature [GET] [/rand.txt] [] []
[INF]       curl.cpp:url_to_host(101): url is https://s3.amazonaws.com
[INF]       curl.cpp:GetObjectRequest(3058): downloading... [path=/rand.txt][fd=7]
[INF]       curl.cpp:RequestPerform(2051): HTTP response code 206
[INF] s3fs.cpp:s3fs_getattr(841): [path=/rand.txt]
[INF] s3fs.cpp:s3fs_flush(2185): [path=/rand.txt][fd=7]
[INF]       fdcache.cpp:RowFlush(1434): [tpath=][path=/rand.txt][fd=7]
[INF] s3fs.cpp:s3fs_release(2238): [path=/rand.txt][fd=7]
[INF]       fdcache.cpp:GetFdEntity(1995): [path=/rand.txt][fd=7]</pre>


<p>ä»¥ä¸Šã€ã¡ã‚‡ã£ã¨ãƒãƒã£ãŸãŒã§ãã¦ã¿ã‚‹ã¨ã‚ã£ã•ã‚Šæš—å·åŒ–ã—ãŸS3ãƒã‚±ãƒƒãƒˆãŒæ‰±ãˆãŸã€‚</p>

<p>ã§ã€ã€Œã“ã‚Œã‚’provisioningã™ã‚‹ã®æ™‚é–“ãŒãªã„ãªãƒ¼ã€ã¨ã‹æ€ã£ã¦ãŸã‚‰æ–œã‚å¾Œã‚ã®ãƒ™ãƒ†ãƒ©ãƒ³ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãŒã‚µã‚¯ãƒƒã¨itamaeã®recipeã«ã—ã¦ãã‚ŒãŸã€‚æ„Ÿè¬ã€‚</p>

-----
--------
AUTHOR: mazgi
TITLE: &lt;mazgi.github.io ç§»è¡Œæ¸ˆ&gt;S3+CloudFrontã‚’Terraformã§è¨­å®šã—ã¦CircleCIã§æ›´æ–°ã™ã‚‹
BASENAME: s3+cloudfront-website-with-terraform-and-circleci
STATUS: Publish
ALLOW COMMENTS: 1
CONVERT BREAKS: 0
DATE: 02/15/2018 05:24:40
CATEGORY: Terraform
CATEGORY: Infrastructure as Code
CATEGORY: Amazon S3
CATEGORY: AWS
CATEGORY: Amazon CloudFront
CATEGORY: Hugo
CATEGORY: CircleCI 2.0
CATEGORY: CircleCI
IMAGE: https://cdn-ak.f.st-hatena.com/images/fotolife/m/mazgi/20180215/20180215023829.png
-----
BODY:
<p>ç§»å‹•ã—ã¾ã—ãŸ=> <a href="https://mazgi.github.io/posts/2018.02/s3+cloudfront-website-with-terraform-and-circleci/">mazgi.log :: S3 + CloudFront&#x3092;Terraform&#x3067;&#x8A2D;&#x5B9A;&#x3057;&#x3066;CircleCI&#x3067;&#x66F4;&#x65B0;&#x3059;&#x308B;</a></p>

<p>ã€ŒTerraformã§S3+CloudFront+SSL/TLSè¨¼æ˜æ›¸ w/ ACMã‚’è¨­å®šã—ã¦Hugoã§ä½œã£ãŸstaticãªWebã‚µã‚¤ãƒˆã‚’CircleCIã§è‡ªå‹•deployã™ã‚‹ã€ã‚„ã¤ãŒã§ããŸã€‚</p>

<h1>ã§ããŸã‚‚ã®</h1>

<p>æ™®é€šã®ã„ã‹ã«ã‚‚<a href="https://gohugo.io/">Hugo</a>ã§ä½œã£ãŸWebã‚µã‚¤ãƒˆãŒã§ããŸã€‚<br/>
ã‚‚ã†2018å¹´ãªã®ã§æ‰‹ã‚ªãƒšãªã©ã›ãšInfrastructure as Codeã§æ§‹ç¯‰ã‹ã¤CIã§ã‚³ãƒ³ãƒ†ãƒ³ãƒ„deployã§ã™ã€‚<br/>
ä¸­èº«ã¯ã¾ã ãªã„ã€‚<br/>
ãã£ã¨é…’ã¨ãƒ¡ã‚·ã«ã¤ã„ã¦ã®ä½•ã‹ãŒæ›¸ã‹ã‚Œã‚‹ã®ã§ã—ã‚‡ã†ã€‚</p>

<p><span itemscope itemtype="http://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/m/mazgi/20180215/20180215023829.png" alt="f:id:mazgi:20180215023829p:plain" title="f:id:mazgi:20180215023829p:plain" class="hatena-fotolife" itemprop="image"></span>
<a href="https://sakemeshi.love/">https://sakemeshi.love/</a></p>

<p>ã“ã‚Œã¯ãã‚‚ãã‚‚<a href="https://denatechstudio.connpass.com/event/72710/">å…ˆæ—¥é–‹å‚¬ã—ãŸãƒãƒƒã‚«ã‚½ãƒ³</a>ã§ã‚„ã‚ã†ã¨ã—ã¦é€”ä¸­ã¾ã§ã—ã‹é€²ã‚ã‚‰ã‚Œãªã‹ã£ãŸã®ã§ã€ãã®è£œç¿’ã‚‚å…¼ã­ã¦ã¾ã™ã€‚</p>

<p>ãªãŠæ¬¡å›ãƒãƒƒã‚«ã‚½ãƒ³ã¯Goã§ã™ï¼</p>

<p><iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fdenatechstudio.connpass.com%2Fevent%2F75706%2F" title="DeNA Techathon: è‘—è€…ã¨å­¦ã¶ã€ŒGoãªã‚‰ã‚ã‹ã‚‹ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã€é»™ã€…ä¼š (2018/02/17 12:00ã€œ)" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"></iframe><cite class="hatena-citation"><a href="https://denatechstudio.connpass.com/event/75706/">denatechstudio.connpass.com</a></cite></p>

<h2>æ§‹æˆ</h2>

<p>å›³ã‚’æãæ°—åŠ›ãŒãªã‹ã£ãŸã®ã§ãƒ†ã‚­ã‚¹ãƒˆã§ã€‚</p>

<h3>ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰ç·¨</h3>

<p><a href="https://www.terraform.io/">Terraform</a>ã§ä»¥ä¸‹ã‚’è¡Œãªã£ã¦ã„ã‚‹ã€‚</p>

<ol>
<li>Route 53ã«ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ã‚¾ãƒ¼ãƒ³æƒ…å ±ã‚’ç™»éŒ²ã™ã‚‹</li>
<li>ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æ›´æ–°ç”¨ã®IAMã‚°ãƒ«ãƒ¼ãƒ—ã¨IAMãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ‰•ã„å‡ºã™</li>
<li>ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æ ¼ç´ç”¨ã®S3ãƒã‚±ãƒƒãƒˆã‚’ä½œã‚‹</li>
<li>ACMã§SSL/TLSè¨¼æ˜æ›¸ã‚’ç™ºè¡Œã™ã‚‹</li>
<li>CloudFront distributionã‚’è¨­å®šã™ã‚‹(ACMã®è¨¼æ˜æ›¸ä½¿ã„ãŸã„ã®ã§)</li>
<li>CloudFront distributionã‚’Route 53ã«ç™»éŒ²ã™ã‚‹</li>
</ol>


<h3>ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æ›´æ–°ç·¨</h3>

<p>GitHubã¸ã®pushã‚’ãƒˆãƒªã‚¬ãƒ¼ã«<a href="https://circleci.com/">CircleCI</a>ã§ä»¥ä¸‹ã‚’è¡Œãªã£ã¦ã„ã‚‹ã€‚</p>

<ol>
<li>Hugoã§staticãªWebã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”Ÿæˆã™ã‚‹</li>
<li>ç”Ÿæˆã—ãŸWebã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’S3ã«åŒæœŸã™ã‚‹</li>
<li>CloudFrontã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹</li>
</ol>


<h3>GitHub</h3>

<p><a href="https://github.com/">GitHub</a>ã§ä»¥ä¸‹ã‚’ç®¡ç†ã—ã¦ã„ã‚‹ã€‚</p>

<ul>
<li><a href="https://github.com/mazgi/sakemeshi.terraform">sakemeshi.terraform</a>

<ul>
<li>Terraformãƒªãƒã‚¸ãƒˆãƒª</li>
<li>ä¸­èº«ã¯Route 53ã«ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ã‚¾ãƒ¼ãƒ³ã‚’ç™»éŒ²ã—ã¦moduleã‚’å‘¼ã³å‡ºã—ã¦ã„ã‚‹ãã‚‰ã„</li>
<li>AWSã®credentialç­‰ã¯ <code>sakemeshi.terraform-secret</code> ãƒªãƒã‚¸ãƒˆãƒªã«ç½®ã„ã¦submoduleã¨ã—ã¦å‚ç…§ã—ã¦ã„ã‚‹</li>
</ul>
</li>
<li><a href="https://github.com/mazgi/terraform-aws-static-website">terraform-aws-static-website</a>

<ul>
<li>è‡ªåˆ†ç”¨Terraform module</li>
<li>S3+CloudFrontã§staticãªWebã‚µã‚¤ãƒˆã‚’ä½œã‚‹ã‚‚ã‚ã‚‚ã‚ãŒè©°ã¾ã£ã¦ã„ã‚‹</li>
</ul>
</li>
<li>(private) sakemeshi.terraform-secret

<ul>
<li>AWSã®credentialãªã©ãŒå…¥ã£ã¦ã„ã‚‹</li>
<li>credential storeå°å…¥ã¨ã‹ã¯ã¾ãŸä»Šåº¦</li>
</ul>
</li>
<li>(private) sakemeshi.content

<ul>
<li>Hugoã«ã‚ˆã‚‹Webã‚µã‚¤ãƒˆã®ä¸­èº«</li>
<li>ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã®masterã«pushã™ã‚‹ã¨CircleCIãŒå‹•ã„ã¦S3ã«deployã•ã‚Œã‚‹</li>
</ul>
</li>
</ul>


<h1>ã¤ãã‚Šã‹ãŸ</h1>

<p>ã‚³ãƒ³ã‚»ãƒ—ãƒˆã¨ã—ã¦ã¯WebUIã‚’æ‰‹ã§ã½ã¡ã½ã¡ã—ãŸããªã„ã®ã§Terraformã§Infra as Codeã—ã¾ã™ï¼</p>

<h2>AWS Webã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã½ã¡ã½ã¡</h2>

<p>æœ€åˆã‹ã‚‰ã‚³ãƒ³ã‚»ãƒ—ãƒˆã«åã™ã‚‹ã‚ˆã†ã ãŒ2018å¹´æ™‚ç‚¹ã§ã¯æ‰‹ã§ãƒãƒãƒãƒã™ã‚‹ã“ã¨ã‚‚ã¾ã å¿…è¦ãªã®ã§ã™ã€‚(ã‚ã‚‹ã„ã¯CLI)<br/>
ä½œã‚‹ã‚‚ã®ã¯2ã¤ã€‚</p>

<h3>Terraform å®Ÿè¡Œç”¨ IAM User</h3>

<p><code>terraform-admin</code> ã¨ã„ã†åå‰ã§ <code>AdministratorAccess</code> ã‚’attacheã—ãŸIAMãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œã‚‹ã€‚<br/>
credentialã‚‚æ‰•ã„å‡ºã—ã¦ã€ä»Šå›ã®å ´åˆã¯ <code>sakemeshi.terraform-secret</code> ãƒªãƒã‚¸ãƒˆãƒªã«pushã—ã¦ãŠãã€‚</p>

<p><span itemscope itemtype="http://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/m/mazgi/20180215/20180215033043.png" alt="f:id:mazgi:20180215033043p:plain" title="f:id:mazgi:20180215033043p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<h3>tfstate æ ¼ç´ç”¨ S3 Bucket</h3>

<p>Terraformã¯è¨­å®šã—ãŸã‚¯ãƒ©ã‚¦ãƒ‰ç’°å¢ƒã®çŠ¶æ…‹ã‚’ <code>tfstate</code> ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã§ç®¡ç†ã™ã‚‹ã®ã§ãã‚Œã‚’æ ¼ç´ã™ã‚‹S3ãƒã‚±ãƒƒãƒˆã‚’ä½œã‚‹ã€‚</p>

<p>ãƒã‚±ãƒƒãƒˆåã¯ <code>${AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆå}-terraform</code> ã¨ã—ã¦ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã€‚<br/>
å…ˆã»ã©ä½œã£ãŸIAMãƒ¦ãƒ¼ã‚¶ãƒ¼ <code>terraform-admin</code> ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚Œã°è‰¯ã„ã€‚</p>

<p><span itemscope itemtype="http://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/m/mazgi/20180215/20180215033214.png" alt="f:id:mazgi:20180215033214p:plain" title="f:id:mazgi:20180215033214p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<p>è©³ã—ãã¯ä»¥ä¸‹å‚ç…§ã€‚</p>

<p><a href="https://www.terraform.io/docs/backends/types/s3.html">Backend Type: s3 - Terraform by HashiCorp</a></p>

<h2>Infra as Terraform</h2>

<h3>ã‚¤ãƒ³ãƒ•ãƒ©ã‚’ã‚³ãƒ¼ãƒ‰ã§æ›¸ã</h3>

<p>Terraformã§æ§‹ç¯‰ã™ã‚‹ã‚‚ã‚ã‚‚ã‚ã¯å°‚ç”¨ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã‚’ä½œã£ã¦ <code>terraform.tf</code> ã«æ›¸ãã€‚<br/>
å…ˆè¿°ã®é€šã‚Šã“ã“ã§å…¬é–‹ã—ã¦ã„ã‚‹ã€‚</p>

<p><iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fgithub.com%2Fmazgi%2Fsakemeshi.terraform" title="mazgi/sakemeshi.terraform" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"></iframe><cite class="hatena-citation"><a href="https://github.com/mazgi/sakemeshi.terraform">github.com</a></cite></p>

<p>ä¸»ãªå†…å®¹ã¯ä»¥ä¸‹ã®é€šã‚Šã€‚</p>

<ul>
<li><code>prepare.sh</code>

<ul>
<li>terraformãƒã‚¤ãƒŠãƒªã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã¨å±•é–‹</li>
<li>å¿…è¦ãªç’°å¢ƒå¤‰æ•°ã®export</li>
<li>ãªãŠå‘½åã¯è·å ´ã®æ–‡åŒ–ã«ç”±æ¥ã™ã‚‹</li>
</ul>
</li>
<li><code>terraform.tf</code>

<ul>
<li>Terraformã§è¡Œã„ãŸã„ã‚‚ã‚ã‚‚ã‚</li>
<li>ãŸã ã—ã»ã¨ã‚“ã©ã¯moduleã«è¿½ã„å‡ºã—ã¦ã„ã‚‹ã®ã§ã€å®Ÿéš›ã®å†…å®¹ã¯Route 53ã®ã‚¾ãƒ¼ãƒ³è¨­å®šã¨moduleã®èª­ã¿å‡ºã—ç¨‹åº¦</li>
</ul>
</li>
<li><code>terraform.tfvars</code>

<ul>
<li>å¾Œè¿°ã®privateãªcredentialãƒªãƒã‚¸ãƒˆãƒªå†…ã¸ã®symlink</li>
<li>AWSã®ACCESS_KEYã‚„SECRET_KEYãªã©ãŒæ›¸ã‹ã‚Œã¦ã„ã‚‹</li>
</ul>
</li>
</ul>


<p><code>terraform.tf</code> ã§å‚ç…§ã—ã¦ã„ã‚‹moduleã¯å…¬é–‹ã—ã¦ã„ã‚‹ãŒå¾Œè¿°ã®ã‚¨ãƒ©ãƒ¼ã‚„ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ãŒå›ºå®šãªã©ã®æ®‹èª²é¡ŒãŒã‚ã‚‹ã€‚<br/>
<a href="https://registry.terraform.io/modules/mazgi/static-website/aws/0.0.2">Terraform Module Registry</a></p>

<p>å…ˆè¿°ã®é€šã‚ŠTerraformã‚’å®Ÿè¡Œã™ã‚‹IAMãƒ¦ãƒ¼ã‚¶ãƒ¼ã®credentialç­‰ã¯åˆ¥ã®privateãƒªãƒã‚¸ãƒˆãƒªã‚’ä½œã£ã¦é…ç½®ã—ã¦ã„ã‚‹ã€‚<br/>
å…¬é–‹ã§ããªã„ãŒä¸­èº«ã¯ã“ã®ç¨‹åº¦ã€‚</p>

<p><span itemscope itemtype="http://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/m/mazgi/20180215/20180215043508.png" alt="f:id:mazgi:20180215043508p:plain" title="f:id:mazgi:20180215043508p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<h3>Terraform å®Ÿè¡Œ</h3>

<p>ã‚ˆã†ã‚„ãTerraformã‚’å®Ÿè¡Œã§ãã‚‹ç’°å¢ƒãŒæ•´ã£ãŸã®ã§å®Ÿè¡Œï¼<br/>
ãªãŠ <code>prepare.sh</code> ã¯ç’°å¢ƒå¤‰æ•°ã‚’exportã™ã‚‹ã®ã§å¿…ãš <code>source</code> ã™ã‚‹ã€‚</p>

<pre class="code" data-lang="" data-unlink>$ source prepare.sh
$ bin/terraform apply</pre>


<p>å®Ÿè¡Œã™ã‚‹ã¨åˆå›ã¯ã‚‚ã‚ã‚‚ã‚ã®ãƒªã‚½ãƒ¼ã‚¹ãŒä½œã‚‰ã‚Œã€1ä»¶ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã€‚<br/>
2å›ç›®ä»¥é™ã¯ã“ã®ã‚ˆã†ã«1ä»¶ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã€‚ã€‚<br/>
å¾Œè¿°ã™ã‚‹ã€‚</p>

<p><span itemscope itemtype="http://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/m/mazgi/20180215/20180215035427.png" alt="f:id:mazgi:20180215035427p:plain" title="f:id:mazgi:20180215035427p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<p>ç´°ã‹ã„ã“ã¨ã‚’æ›¸ãã¨ä»Šå›ã®ãƒ‰ãƒ¡ã‚¤ãƒ³è‡ªä½“ã¯Route 53ã§ç®¡ç†ã—ã¦ã„ãªã„ãŸã‚ã€åˆ¥é€”ãƒãƒ¼ãƒ ã‚µãƒ¼ãƒãƒ¼ã‚’Route 53ã«å‘ã‘ã¦ãŠãç­‰ã®æ‰‹é †ãŒå¿…è¦ã§ã™ã€‚</p>

<h2>CircleCIã§è‡ªå‹•build &amp;&amp; deploy</h2>

<p>Terraformã§ç©ºã®Webã‚µã‚¤ãƒˆãŒã§ããŸã®ã§ä¸­èº«ã‚’ä½œã£ã¦ã„ãã€‚</p>

<p>GitHubãƒªãƒã‚¸ãƒˆãƒªã‚’ç”¨æ„ã—ã¦ãŠã‚‚ã‚€ã‚ã« <code>hugo new site .</code> ã™ã‚‹ã€‚<br/>
é©å½“ãªãƒ†ãƒ¼ãƒã‚’submoduleã¨ã—ã¦è¿½åŠ ã™ã‚‹ã€‚<br/>
<a href="https://gohugo.io/getting-started/quick-start/">Quick Start</a>é€šã‚Šã€‚</p>

<p>Hugoã¯ä»Šå¾ŒãŒã‚“ã°ã‚‹ã“ã¨ã«ã—ã¦ä»Šå›ã¯CircleCI 2.0ã‚’ãŒã‚“ã°ã‚‹ã€‚<br/>
çµè«–ã‚’æ›¸ãã¨<a href="https://gist.github.com/mazgi/6c0dd922f89eee80fe5da6317d7e7aed">ã“ã†ã„ã† <code>.circleci/config.yml</code> </a>ã‚’æ›¸ã„ãŸã€‚<br/>
ãƒãƒã£ãŸã€‚</p>

<p>ãã®ã»ã‹ã¯æœ¬å½“ã« <code>hugo new site .</code> ã—ãŸã¾ã¾ã€‚</p>

<p><span itemscope itemtype="http://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/m/mazgi/20180215/20180215045406.png" alt="f:id:mazgi:20180215045406p:plain" title="f:id:mazgi:20180215045406p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<p>ä½•ã¯ã¨ã‚‚ã‚ã‚Œã“ã‚Œã§CircleCIã§ã®Webã‚µã‚¤ãƒˆã®ãƒ“ãƒ«ãƒ‰ã¨S3ã¸ã®åŒæœŸãŒè¡Œãˆã‚‹ã‚ˆã†ã«ãªã£ãŸï¼ã‚ã§ãŸã„ï¼</p>

<p><span itemscope itemtype="http://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/m/mazgi/20180215/20180215045503.png" alt="f:id:mazgi:20180215045503p:plain" title="f:id:mazgi:20180215045503p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<h1>ãŠã‚ã‚Šã«</h1>

<p>ã¨ã„ã†ã“ã¨ã§(ã»ã¼)æ‰‹ã§ã½ã¡ã½ã¡ã›ãšã«Infrastructure as Codeã§staticãªWebã‚µã‚¤ãƒˆãŒä½œã‚ŒãŸã—æ›´æ–°ã®ä»•çµ„ã¿ã‚‚ã§ããŸï¼ã‚„ã£ãŸã­ï¼</p>

<h2>ãƒã‚¤ãƒ³ãƒˆ</h2>

<p>ä»¥ä¸‹ã‚ã¾ã‚Šæ›¸ã‘ã¦ãªã„ã®ã§æ©Ÿä¼šãŒã‚ã£ãŸã‚‰æ›¸ãã€‚</p>

<h3>Terraform</h3>

<ul>
<li>æœ€è¿‘ã®Terraformã¯ <code>terraform init</code> ãŒå¿…è¦

<ul>
<li>ãã®ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ã®åˆå›å®Ÿè¡Œã‚„moduleã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸Šã’ãŸéš›ãªã©</li>
</ul>
</li>
<li>æœ€è¿‘ã®Terraformã¯ <code>terraform apply</code> ã—ãŸã‚ã¨æœ¬å½“ã«å®Ÿè¡Œã™ã‚‹ã‹èã„ã¦ãã‚‹

<ul>
<li>ãã®ãŸã‚ <code>terraform apply[ENTER]</code> ã—ã¦ã‚³ãƒ¼ãƒ’ãƒ¼ã‚’è²·ã„ã«ã„ãã¨ä½•ååˆ†å¾Œã«æˆ»ã£ã¦ã‚‚ <code>Do you want to perform these actions?</code> ã¨ã„ã†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå‡ºè¿ãˆã¦ãã‚Œã‚‹(ã‚‚ã¡ã‚ã‚“ã‚ãªãŸã®ã‚¯ãƒ©ã‚¦ãƒ‰ç’°å¢ƒã«ã¯ä½•ã‚‚å¤‰åŒ–ã¯ãªã„)</li>
<li><code>terraform apply -auto-approve</code> ã¨ã„ã†ã‚ã‚‹ã„ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹</li>
</ul>
</li>
<li>tfstateæ ¼ç´ç”¨S3ãƒã‚±ãƒƒãƒˆ(S3 backend)ã‚’ä½¿ã†ãŸã‚ã«ã¯ç’°å¢ƒå¤‰æ•°or <code>~/.aws</code> å†…ã«credentialãŒå¿…è¦

<ul>
<li>ç§ã¯ <code>prepare.sh</code> ã®ä¸­ã§exportã—ã¦ã„ã‚‹(ã®ã§å¿…ãš <code>source</code> ã™ã‚‹)</li>
</ul>
</li>
<li>ACMã®æ¤œè¨¼ãŒå¾“æ¥ã®ãƒ¡ãƒ¼ãƒ«ã ã‘ã§ã¯ãªãDNSã§ã‚‚ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¦Terraformã§ã‚‚å¯¾å¿œã—ã¦ã„ãŸ

<ul>
<li><a href="https://github.com/terraform-providers/terraform-provider-aws/pull/2813">New Resources: aws_acm_certificate and aws_acm_certificate_validation by flosell &middot; Pull Request #2813 &middot; terraform-providers/terraform-provider-aws &middot; GitHub</a></li>
<li>ã“ã‚Œã®ãŠã‹ã’ã§ <code>terraform apply</code> ã ã‘ã§è¨¼æ˜æ›¸ç™ºè¡Œã—ã¦Issuedã«ãªã‚‹ã¨ã“ã‚ã¾ã§å®Ÿç¾ã§ããŸ</li>
<li>ãŸã ã—<a href="https://github.com/mazgi/terraform-aws-static-website/blob/v0.0.2/main.tf#L9"> <code>AWS provider 1.9</code> ä»¥ä¸ŠãŒå¿…è¦</a></li>
</ul>
</li>
</ul>


<h3>CircleCI 2.0</h3>

<ul>
<li>Dockerä¾¿åˆ©ã ã‘ã©ã‚‚

<ul>
<li>ä½¿ã†Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã«ã‚‚ã‚ˆã‚‹ãŒå½“ç„¶ <code>curl</code> ã‚‚ <code>git</code> ã‚‚å…¥ã£ã¦ãªã‹ã£ãŸã‚Šã™ã‚‹</li>
<li>è‡ªåˆ†ç”¨Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ä½œã‚ŠãŸããªã‚‹</li>
<li>é–‹ç™ºç’°å¢ƒãŒDocker Hubã«å…¬é–‹ã§ãã‚‹Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã§å®Œçµã—ã¦ã„ã‚‹å ´åˆã¯ä¾¿åˆ©ãã†</li>
</ul>
</li>
<li><code>checkout</code> ã« <code>git clone --recursive</code> ç›¸å½“ã®æ©Ÿèƒ½ãŒãªã„(?)

<ul>
<li>ãã®ãŸã‚<a href="https://github.com/mazgi/sakemeshi.content/blob/master/.circleci/config.yml#L20-L21"><code>checkout</code> ã®æ¬¡ã®è¡Œã§ <code>git submodule update</code> ã‚’æ›¸ã„ãŸ</a></li>
</ul>
</li>
</ul>


<h2>(ç‰¹ã«)ãƒãƒã‚Šã©ã“ã‚</h2>

<h3>terraform apply æ™‚ã® aws_acm_certificate_validation ã‚¨ãƒ©ãƒ¼</h3>

<p><code>terraform apply</code> ã™ã‚‹éš›ã«æ¯å›ã“ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã€‚</p>

<pre class="code" data-lang="" data-unlink>Error: Error applying plan:

1 error(s) occurred:

* module.static-website.aws_acm_certificate_validation.website: 1 error(s) occurred:

* aws_acm_certificate_validation.website: Certificate needs [VALIDATON_RECORD.YOURDOMAIN VALIDATON_RECORD.YOURDOMAIN] to be set but only [VALIDATON_RECORD.YOURDOMAIN] was passed to validation_record_fqdns</pre>


<p>ã“ã‚Œ <code>YOURDOMAIN</code> ã¨ <code>*.YOURDOMAIN</code> ã§ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒåŒã˜ã§ã€Route 53ä¸Šã¯1ãƒ¬ã‚³ãƒ¼ãƒ‰ã—ã‹ãªã„ã‚‚ã®ã‚’Terraformã®<a href="https://github.com/terraform-providers/terraform-provider-aws/blob/v1.9.0/aws/resource_aws_acm_certificate_validation.go">AWS provider</a>ãŒ2ãƒ¬ã‚³ãƒ¼ãƒ‰è¿”ã£ã¦ãã‚‹ã“ã¨ã‚’æœŸå¾…ã—ã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã‚‹ã‚“ã ã‘ã©ã©ã†ã—ãŸã‚‚ã®ã‹ã€‚</p>

<h3>CircleCI 2.0 ã§ attach_workspace ã™ã‚‹ãŸã‚ã« ca-certificates ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒå¿…è¦</h3>

<p>å‰ãƒ•ã‚§ã‚¤ã‚ºã§æ°¸ç¶šåŒ–ã—ãŸãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’å¾Œãƒ•ã‚§ã‚¤ã‚ºã§ <code>attach_workspace</code> ã—ã¦å–ã‚Šå‡ºã™ãŸã‚ã« <code>ca-certificates</code> ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å¿…è¦ãªã®ã¯ãƒãƒã£ãŸã€‚<br/>
ã“ã¡ã‚‰ã®è¨˜äº‹ã«åŠ©ã‘ã‚‰ã‚ŒãŸã€‚<br/>
<a href="https://qiita.com/gcoka/items/8a9cd59fec324a1fca19">CircleCI&#x3067;x509&#x3068;&#x3044;&#x3046;&#x8A3C;&#x660E;&#x66F8;&#x30A8;&#x30E9;&#x30FC;&#x306B;&#x906D;&#x9047;&#x3057;&#x305F;&#x3068;&#x304D;&#x306E;&#x5BFE;&#x51E6;</a></p>

<p>ãã‚Œã¯ãã†ã¨å†æ²ã™ã‚‹ãŒ <code>.circleci/config.yml</code> ãŒã“ã‚“ãªé•·ã•ã«ãªã£ãŸã€‚ã¤ã‚‰ã„ã€‚<br/>
workflowã¨ã—ã¦buildã¨deployãŒåˆ†ã‹ã‚Œã‚‹ã®ã¯ç¶ºéº—ã ã‘ã©ã‚‚ã€‚ã€‚</p>

<p><script src="https://gist.github.com/mazgi/6c0dd922f89eee80fe5da6317d7e7aed.js"> </script><cite class="hatena-citation"><a href="https://gist.github.com/mazgi/6c0dd922f89eee80fe5da6317d7e7aed">gist.github.com</a></cite></p>

<p>ã¨ã‚‚ã‹ãã“ã†ã„ã†ã‚µã‚¤ãƒˆã‚’ã„ãã¤ã‹ä½œã‚ŠãŸã„ãƒ‹ãƒ¼ã‚ºãŒã‚ã£ãŸã®ã§ã‚„ã£ã¦ã„ãã¾ã™ã€‚</p>

-----
--------
AUTHOR: mazgi
TITLE: &lt;mazgi.github.io ç§»è¡Œæ¸ˆ&gt;ç°¡æ˜“ãªæŠ€è¡“ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’Hugoã§æ›¸ãã¨ä¾¿åˆ©ã ã£ãŸ
BASENAME: technical-docs-with-hugo
STATUS: Publish
ALLOW COMMENTS: 1
CONVERT BREAKS: 0
DATE: 12/08/2017 07:00:00
IMAGE: https://cdn-ak.f.st-hatena.com/images/fotolife/m/mazgi/20171207/20171207195147.png
-----
BODY:
<p>ã“ã®è¨˜äº‹ã¯ä»¥ä¸‹ã«ç§»è¡Œã—ã¾ã—ãŸã€‚</p>

<p><a href="https://mazgi.github.io/posts/2017.12/technical-docs-with-hugo/">mazgi.log :: &#x7C21;&#x6613;&#x306A;&#x6280;&#x8853;&#x30C9;&#x30AD;&#x30E5;&#x30E1;&#x30F3;&#x30C8;&#x3092;Hugo&#x3067;&#x66F8;&#x304F;&#x3068;&#x4FBF;&#x5229;&#x3060;&#x3063;&#x305F;</a></p>

<hr />

<p>ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’Hugoã§æ›¸ã„ã¦ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã¨ä¸€ç·’ã«é…ã£ãŸã‚‰ä¾¿åˆ©ãã†ã ã£ãŸã®ã§ã‚„ã£ã¦ã¿ãŸã€‚</p>

<p><iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fgohugo.io%2F" title="The worldâ€™s fastest framework for building websites" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"></iframe><cite class="hatena-citation"><a href="https://gohugo.io/">gohugo.io</a></cite></p>

<h2>ã‚„ã‚ŠãŸã„ã“ã¨</h2>

<p>ä»•äº‹ã§ä»–ç¤¾ã•ã‚“ã«ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ã‚»ãƒƒãƒˆã§ãŠæ¸¡ã—ã—ãŸã„ã®ã ã‘ã©ç¤¾ã§ã¯GitHub Enterpriseã‚’ä½¿ã£ã¦ã„ã‚‹ã®ã§ãƒªãƒã‚¸ãƒˆãƒªã‚’ç›´æ¥è¦‹ã¦ã„ãŸã ãã“ã¨ãŒé›£ã—ã„ã‚±ãƒ¼ã‚¹ãŒã‚ã‚‹ã€‚</p>

<p>è¦æ¨¡ãŒå¤§ãã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãªã‚‰<a href="http://www.sphinx-doc.org/">Sphinx</a>ä½¿ã†ã¨(ã‚„ã‚‹æ°—æ¬¡ç¬¬ã§)ã„ãã‚‰ã§ã‚‚ç¶ºéº—ãªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒæ›¸ã‘ãã†ã§ã¯ã‚ã‚‹ã‘ã©ã€è¦æ¨¡ãŒãã‚Œã»ã©ã˜ã‚ƒãªã„ã†ã¡ã¯ã‚µã‚¯ãƒƒã¨Markdownã§æ›¸ã„ã¦ã€ã§ã‚‚ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒæ•´åˆæ€§å–ã‚Œã¦ã¦ã»ã—ã„ã¨ã„ã†æ°—æŒã¡ã«ãªã‚‹ã€‚<br/>
(ä»Šã¯<a href="http://www.sphinx-doc.org/en/stable/markdown.html">Sphinxã‚‚Markdownã§æ›¸ã‘ã‚‹</a>ãã†ã ã€æœ€è¿‘çŸ¥ã£ãŸ)</p>

<p>ãã‚‚ãã‚‚(ç§ã¯)ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›¸ããŸããªã„ã®ã§ã€ã§ãã‚‹ã ã‘ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®æä¾›ã‚„ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚³ãƒ¡ãƒ³ãƒˆã§è³„ã£ã¦æ–‡ç« é‡ã¯æœ€å°é™ã«æŠ‘ãˆãŸã„ã¨ã„ã†ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã‚‚ã‚ã£ãŸã€‚</p>

<p>ãã“ã§ä»¥ä¸‹ã®ã‚ˆã†ãªä½œæˆ¦ã‚’è€ƒãˆãŸã€‚</p>

<h3>ã•ãã›ã‚“</h3>

<ul>
<li>ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯Hugoã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ãªãŒã‚‰Markdownã§æ›¸ã</li>
<li>ç”Ÿæˆã—ãŸHTMLã¯ <code>/docs</code> ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«çªã£è¾¼ã‚€</li>
<li>ç¤¾å†…å‘ã‘ã«ã¯GitHub Pagesã§masterã®HEADã‚’ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã™ã‚‹</li>
<li>ç¤¾å¤–å‘ã‘ã«ã¯æœ€æ–°ãƒªãƒªãƒ¼ã‚¹ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’æä¾›ã™ã‚‹</li>
</ul>


<p>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ãã‚‹ã‹ã‚‰æ›¸ãã®æ¥½ã ã—ã€tagæ‰“ã¦ã‚‹ã‹ã‚‰ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ•´åˆæ€§ã‚‚å–ã‚Šã‚„ã™ã„ã€‚ãã£ã¨ä¾¿åˆ©ï¼</p>

<h2>ã§ããŸã‚‚ã®</h2>

<p>ãƒªãƒã‚¸ãƒˆãƒªã¯ã“ã¡ã‚‰ã€‚</p>

<p><iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fgithub.com%2Fmazgi%2Fexample-document-with-hugo" title="mazgi/example-document-with-hugo" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"></iframe><cite class="hatena-citation"><a href="https://github.com/mazgi/example-document-with-hugo">github.com</a></cite></p>

<p>GitHub Pagesã¯ã“ã¡ã‚‰ã€‚</p>

<p><a href="https://mazgi.github.io/example-document-with-hugo/index.html">Example Document with Hugo</a></p>

<p>ãƒ†ãƒ¼ãƒã¯ã“ã¡ã‚‰ã‚’ä½¿ã‚ã›ã¦ã„ãŸã ã„ãŸã€‚<br/>
ã‚µã‚¤ãƒ‰ãƒãƒ¼ã§ã‚¨ãƒ³ãƒˆãƒªãŒä¸€è¦§ã§ãã¦æŠ€è¡“ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚‰ã—ã•ãŒã‚ã‚‹ã€‚</p>

<p><iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fgithub.com%2Fvjeantet%2Fhugo-theme-docdock" title="vjeantet/hugo-theme-docdock" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"></iframe><cite class="hatena-citation"><a href="https://github.com/vjeantet/hugo-theme-docdock">github.com</a></cite></p>

<h2>å·¥å¤«</h2>

<p><a href="https://github.com/mazgi/example-document-with-hugo/blob/master/docs.source/config.toml">è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¯ã“ã‚Œã€‚</a></p>

<ul>
<li>ä»¥ä¸‹ã§ç”Ÿæˆã—ãŸHTMLå†…ã®ãƒªãƒ³ã‚¯ãŒ <code>/</code> ã‹ã‚‰ã®ç›¸å¯¾PATHã«ãªã‚‹ãµã„ã‚“ã(ã¡ã‚ƒã‚“ã¨èª¿ã¹ã¦ã„ãªã„)

<ul>
<li><code>baseURL = "/"</code></li>
<li><code>relativeURLs = true</code></li>
<li><code>uglyurls = true</code></li>
</ul>
</li>
<li>themeã®æŒ‡å®š</li>
</ul>


<pre class="code" data-lang="" data-unlink>baseURL = &#34;/&#34;
languageCode = &#34;en-us&#34;
DefaultContentLanguage = &#34;en&#34;
title = &#34;Example Document with Hugo&#34;
publishDir = &#34;../docs&#34;
relativeURLs = true
uglyurls = true
theme = &#34;docdock&#34;

[params]
themeVariant = &#34;gray&#34;</pre>


<p>ã¾ãŸã€ã“ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰(Markdownä»–)ã‚’ <code>/docs.source</code> ã«ç½®ãã€ <code>publishDir = "../docs"</code> ã¨è¨­å®šã™ã‚‹ã“ã¨ã§ãƒªãƒã‚¸ãƒˆãƒªã®rootã«ã‚ã¾ã‚Šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç½®ã‹ãªã„ã‚ˆã†ã«ã—ã¦ã„ã‚‹ã€‚<br/>
ã“ã‚Œã¯ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã«ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚‚åŒå±…ã™ã‚‹æƒ³å®šã§ã‚ã‚Šã€rootã«ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¢—ãˆã¦è¦‹é€šã—ãŒã‚ã‚‹ããªã‚‹ã“ã¨ã‚’é¿ã‘ã‚‹ãŸã‚ã€‚</p>

<p>HTMLã‚’ç”Ÿæˆã—ã¦commitã—ã¦pushã—ã¦tagã‚’æ‰“ã£ãŸã‚‚ã®ãŒã“ã¡ã‚‰ã€‚</p>

<p><a href="https://github.com/mazgi/example-document-with-hugo/releases/tag/v0.0.1">Release v0.0.1 &middot; mazgi/example-document-with-hugo &middot; GitHub</a></p>

<p>ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦æ‰‹å…ƒã§é–‹ãã¨ã“ã‚“ãªæ„Ÿã˜ã§ <code>index.html</code> ãŒè¦‹ãˆã‚‹ã€‚<br/>
ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚‚å±•é–‹å¾Œã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚‚ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒŠãƒ³ãƒãƒ¼ãŒå«ã¾ã‚Œã‚ã‹ã‚Šã‚„ã™ã„ã€‚</p>

<p><span itemscope itemtype="http://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/m/mazgi/20171207/20171207195147.png" alt="f:id:mazgi:20171207195147p:plain" title="f:id:mazgi:20171207195147p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<p><code>index.html</code> ã‚‚ãƒªãƒ³ã‚¯å…ˆã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚‚ãƒ–ãƒ©ã‚¦ã‚¶ã§è¡¨ç¤ºã§ãã‚‹ã€‚ä¾¿åˆ©ã€‚</p>

<p><span itemscope itemtype="http://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/m/mazgi/20171207/20171207195157.png" alt="f:id:mazgi:20171207195157p:plain" title="f:id:mazgi:20171207195157p:plain" class="hatena-fotolife" itemprop="image"></span></p>

-----
--------
AUTHOR: mazgi
TITLE: &lt;mazgi.github.io ç§»è¡Œæ¸ˆ&gt;EC2 P3ã§ä½¿ãˆã‚‹ChainerMNå…¥ã‚Šã®Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œã£ãŸ
BASENAME: dockerimage-for-chainermn-on-v100
STATUS: Publish
ALLOW COMMENTS: 1
CONVERT BREAKS: 0
DATE: 12/07/2017 07:16:07
-----
BODY:
<p>ç§»å‹•ã—ã¾ã—ãŸ=> <a href="https://mazgi.github.io/posts/2017.12/dockerimage-for-chainermn-on-v100/">mazgi.log :: EC2 P3&#x3067;&#x4F7F;&#x3048;&#x308B;ChainerMN&#x5165;&#x308A;&#x306E;Docker&#x30A4;&#x30E1;&#x30FC;&#x30B8;&#x3092;&#x4F5C;&#x3063;&#x305F;</a></p>

<p>sonotså…ˆç”Ÿã«ã‚ˆã‚‹ã“ã®è¨˜äº‹ã‚’ã‚„ã£ã¦ã¿ãŸã¨ã„ã†è©±ã§ã™ã€‚</p>

<p><iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fqiita.com%2Fsonots%2Fitems%2Fee247a2e36033646c914" title="docker (nvidia-docker) ã‚’ä½¿ã£ã¦ãƒãƒ«ãƒãƒãƒ¼ãƒ‰ã§ ChainerMN ã‚’å®Ÿè¡Œã™ã‚‹æ–¹æ³•(ä»®) - Qiita" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"></iframe><cite class="hatena-citation"><a href="https://qiita.com/sonots/items/ee247a2e36033646c914">qiita.com</a></cite></p>

<h2>æ¦‚è¦</h2>

<p>Dockerfileã¯ã“ã“ã«ã‚ã‚Šã¾ã™ã€‚</p>

<p><iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fgithub.com%2Fmazgi%2Fdocker-cuda-cv" title="mazgi/docker-cuda-cv" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"></iframe><cite class="hatena-citation"><a href="https://github.com/mazgi/docker-cuda-cv">github.com</a></cite></p>

<p>ãƒ™ãƒ¼ã‚¹ã¯NVIDIAã•ã‚“ã®ã‚ªãƒ•ã‚£ã‚·ãƒ£ãƒ«ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ã€‚</p>

<p><a href="https://hub.docker.com/r/nvidia/cuda/">https://hub.docker.com/r/nvidia/cuda/</a></p>

<h2>å®Ÿè¡Œçµæœ</h2>

<p>ChainerMNã®exampleã‚’è©¦ã—ãŸçµæœã¯ã“ã¡ã‚‰ã€‚<br/>
ä»Šã®ã¨ã“ã‚ã‚·ãƒ³ã‚°ãƒ«Nodeã‚·ãƒ³ã‚°ãƒ«GPUã¨ã‚·ãƒ³ã‚°ãƒ«Nodeãƒãƒ«ãƒGPUã—ã‹è©¦ã—ã¦ãªã„ã§ã™ã€‚</p>

<p><script src="https://gist.github.com/mazgi/e095e4756f14ebb9db5c26cd70b23c63.js"> </script><cite class="hatena-citation"><a href="https://gist.github.com/mazgi/e095e4756f14ebb9db5c26cd70b23c63">gist.github.com</a></cite></p>

<p>æ‰‹é †ã¯ã“ã¡ã‚‰ã®é€šã‚Šãªã‚“ã§ã™ãŒæ™‚é–“ãŒå–ã‚Œã¦ã„ãªã„...</p>

<p><a href="https://qiita.com/sonots/items/ee247a2e36033646c914#%E3%83%9E%E3%83%AB%E3%83%81%E3%83%8E%E3%83%BC%E3%83%89">docker (nvidia-docker) &#x3092;&#x4F7F;&#x3063;&#x3066;&#x30DE;&#x30EB;&#x30C1;&#x30CE;&#x30FC;&#x30C9;&#x3067; ChainerMN &#x3092;&#x5B9F;&#x884C;&#x3059;&#x308B;&#x65B9;&#x6CD5;(&#x4EEE;)</a></p>

<p>P3ã˜ã‚ƒãªãã¦ã‚‚å‹•ãã¯ãšã§ã™ãŒã€ãƒ›ã‚¹ãƒˆå´ã«GPUã¨nvidia-dockerã¯å¿…è¦ã§ã™ã€‚<br/>
ä»Šå›ã¯ç¤¾ã®ç’°å¢ƒã§è©¦ã—ãŸã®ã§sonotsä¾¿åˆ©å…ˆç”Ÿç’°å¢ƒã®æ©æµã‚’å—ã‘ã¦ã¾ã™ğŸ™</p>

<p><iframe src="https://hatenablog-parts.com/embed?url=http%3A%2F%2Fblog.livedoor.jp%2Fsonots%2Farchives%2F49502478.html" title="DeNA TechCon 2017 ã¨ Developers Summit 2017 ã§DeNAã®æ©Ÿæ¢°å­¦ç¿’åŸºç›¤ã¨åˆ†æåŸºç›¤ã®è¬›æ¼”ã‚’ã—ã¾ã—ãŸ : sonots:blog" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"></iframe><cite class="hatena-citation"><a href="http://blog.livedoor.jp/sonots/archives/49502478.html">blog.livedoor.jp</a></cite></p>

<p>ã‚¤ãƒã‹ã‚‰æ§‹ç¯‰ã™ã‚‹å ´åˆã¯ã“ã†ã„ã†è¨˜äº‹ãŒå‚è€ƒã«ãªã‚Šãã†ã€‚</p>

<p><iframe src="https://hatenablog-parts.com/embed?url=http%3A%2F%2Fchie8842.hatenablog.com%2Fentry%2F2017%2F11%2F27%2F221551" title="p3ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹(V100)ä¸Šã§CUDA+CUDNN+Tensorflowã‚’å‹•ã‹ã™ã®ãŒå¤§å¤‰ã ã£ãŸã®ã§ãã‚ãã€‚ - ç„¼è‚‰ãŒé£Ÿã¹ãŸã„" class="embed-card embed-blogcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 190px; max-width: 500px; margin: 10px 0px;"></iframe><cite class="hatena-citation"><a href="http://chie8842.hatenablog.com/entry/2017/11/27/221551">chie8842.hatenablog.com</a></cite></p>

<h2>çµŒç·¯ã¨ã‹</h2>

<p>ã‚ã§ãŸãè¨˜äº‹ã‚‚å‡ºãŸã®ã§è‰²ã€…è¨€ãˆã‚‹ã‚ˆã†ã«ãªã£ãŸã®ã§ã™ãŒã€å®Ÿã¯ã‚ã‚ŠãŒãŸã„ã“ã¨ã«P3ã®å…ˆè¡Œæ¤œè¨¼ã¨ã„ã†ã®ã‚’ã•ã›ã¦ã„ãŸã ã„ã¦ã¾ã—ãŸã€‚<br/>
(ãªãŠã‚¤ãƒ™ãƒ³ãƒˆå½“æ—¥ã¯ã‚«ãƒ¡ãƒ©ãƒãƒ³ã—ã¦ã¾ã—ãŸ)</p>

<p><iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fengineer.dena.jp%2F2017%2F12%2Famazon-ec2-p3pose-estimation.html" title="Amazon EC2 P3ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ãŠã‘ã‚‹Pose Estimationé€Ÿåº¦å‘ä¸Šæ¤œè¨¼ - Technology of DeNA" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"></iframe><cite class="hatena-citation"><a href="https://engineer.dena.jp/2017/12/amazon-ec2-p3pose-estimation.html">engineer.dena.jp</a></cite></p>

<p>ã“ã®æ¤œè¨¼æ™‚ç‚¹ã§ã¯ChainerMNã§ã¯ãªãChainerã§ã€ç’°å¢ƒã‚‚VMä¸Šã«ç›´æ¥ä½œã£ã¦ãŸã®ã§ã™ãŒã€ãã®å¾Œéƒ¨å†…ã‹ã‚‰ã€ŒDockerã‚¤ãƒ¡ãƒ¼ã‚¸ã«ãªã£ã¦ãŸã»ã†ãŒä¾¿åˆ©ã€ã¨ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã„ãŸã ãå…ˆè¡Œè€…ã®è¨˜äº‹ã‚’å‚è€ƒã«æ‰‹æ¢ã‚Šã—ã¦ã‚‹çŠ¶æ³ã§ã™ã€‚<br/>
ç§ã¯MLã‚ã‹ã‚‰ãªã„ãƒãƒ³ãªã®ã§ã™ãŒã€æœ€åˆ cuDNN 7 + CuPy 1.0.3 ã§ç’°å¢ƒä½œã‚ã†ã¨ã—ã¦ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒåˆã‚ãªãã¦ã©ã†ã—ã‚ˆï¼ã¨æ€ã£ã¦ãŸã‚‰ã€Œä»Šæ—¥ cuDNN 7 å¯¾å¿œã® CuPy 2.0 ãƒªãƒªãƒ¼ã‚¹ã™ã‚‹ã‚ˆï¼ã€ã¨æ•™ãˆã¦ã„ãŸã ã„ãŸã‚Šã¨ã‹ã€ã“ã®æ¥­ç•Œæœ¬å½“ã«æ•°æ™‚é–“å˜ä½ã§é€²æ­©ã—ã¦ã¦ã™ã”ã„ã€‚</p>

<p>ã“ã†ã„ã†ç”¨é€”ã ã¨ã‚³ãƒ³ãƒ†ãƒŠã»ã‚“ã¨ä¾¿åˆ©ãªã‚“ã§ã™ã‘ã©ã€ã§ã‚‚Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®å‘½åã‚€ãšã‹ã—ã„ã€‚<br/>
<code>mazgi/cuda-cv:9.0-cudnn7-devel-ubuntu16.04</code> ã˜ã‚ƒãªãã¦ã€<br/>
<code>mazgi/cuda-cv-9.0-cudnn7-devel-ubuntu16.04:latest</code> ã¨ã‹ã«ã—ãŸã»ã†ãŒã„ã„ã®ã‹ãª(é•·ã„)ã€‚<br/>
ãã‚‚ãã‚‚ã®è©±ã¨ã—ã¦ã¯å®Ÿè³ªChainer &amp; ChainerMNã‚¤ãƒ¡ãƒ¼ã‚¸ãªã®ã§ãã†ã„ã†åå‰ã«ã™ã¹ãã ã—(ã•ã‚‰ã«é•·ããªã‚‹)ã€‚</p>

-----
--------
